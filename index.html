<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trip Planner Local</title>

  <!-- Drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <!-- Calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #0a0b0e;
      --panel: #121318;
      --panel-hover: #181a22;
      --muted: #8b95a5;
      --text: #f0f4f8;
      --text-secondary: #c5ced8;
      --line: #2a2f3d;
      --line-light: #353b4d;
      --chip: #1e2230;
      --accent: #5b8def;
      --accent-soft: rgba(91, 141, 239, 0.15);
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 16px;
      align-items: center;
      background: var(--panel);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .wrap {
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: calc(100vh - 60px);
    }

    aside {
      border-right: 1px solid var(--line);
      padding: 16px;
      background: var(--panel);
      overflow-y: auto;
    }

    main {
      padding: 20px;
      background: var(--bg);
      overflow-y: auto;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--line-light); }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      display: block;
    }

    input, select, textarea, button {
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      padding: 10px 12px;
      font-size: 13px;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: var(--panel-hover); }
    button.primary {
      background: linear-gradient(135deg, #1e3a6e 0%, #2a4a8e 100%);
      border-color: #3a5a9e;
    }
    button.primary:hover { background: linear-gradient(135deg, #2a4a8e 0%, #3a5a9e 100%); }
    button.danger {
      background: #3d1f1f;
      border-color: #5c2d2d;
    }
    button.danger:hover { background: #4d2828; }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
    }
    .tab {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); background: var(--panel-hover); }
    .tab.active {
      background: var(--chip);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .city-pill {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--chip);
      display: flex;
      gap: 10px;
      align-items: center;
      transition: all 0.2s;
    }
    .city-pill:hover { border-color: var(--line-light); }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      display: inline-block;
      flex-shrink: 0;
      box-shadow: 0 0 8px currentColor;
    }

    .city-list { display: flex; flex-direction: column; gap: 10px; }

    .city-item {
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--bg);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      transition: all 0.2s;
    }
    .city-item:hover { border-color: var(--line-light); background: var(--panel-hover); }
    .city-item .handle { cursor: grab; color: var(--muted); font-size: 14px; }
    .city-item .name { font-weight: 700; }

    .days { display: flex; flex-direction: column; gap: 12px; }

    details {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--bg);
      padding: 12px;
      transition: all 0.2s;
    }
    details:hover { border-color: var(--line-light); }
    details[open] { background: var(--panel); }

    summary {
      cursor: pointer;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      padding: 4px 0;
      list-style: none;
    }
    summary::-webkit-details-marker { display: none; }
    summary::before {
      content: "‚ñ∏";
      color: var(--muted);
      transition: transform 0.2s;
      margin-right: 8px;
    }
    details[open] summary::before { transform: rotate(90deg); }

    .events {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-left: 20px;
      border-left: 2px solid var(--line);
    }

    .event {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--bg);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      transition: all 0.2s;
    }
    .event:hover {
      border-color: var(--line-light);
      background: var(--panel-hover);
      transform: translateX(2px);
    }
    .event .left { display: flex; flex-direction: column; gap: 6px; }
    .event .title {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .event .title .icon { font-size: 16px; }
    .event .meta {
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .event .meta .type-badge {
      background: var(--chip);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .event .meta .time {
      color: var(--text-secondary);
      font-weight: 500;
    }
    .event .meta .ticket-status {
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }
    .event .meta .ticket-status.pending {
      background: rgba(251, 191, 36, 0.15);
      color: var(--warning);
    }
    .event .meta .ticket-status.bought {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
    }
    .event .right { display: flex; gap: 6px; align-items: center; }

    a {
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s;
    }
    a:hover { opacity: 0.8; }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .hr { height: 1px; background: var(--line); margin: 14px 0; }

    .ticket {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--bg);
      transition: all 0.2s;
    }
    .ticket:hover { border-color: var(--line-light); }
    .ticket .tname { font-weight: 700; }
    .ticket input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--success);
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--bg);
      font-size: 12px;
    }

    /* ==================== TIMELINE CONTINUA ==================== */
    .timeline-container {
      padding: 20px 0;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--line);
    }

    .timeline-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    .timeline-stats {
      display: flex;
      gap: 20px;
    }

    .timeline-stat {
      text-align: center;
    }

    .timeline-stat .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }

    .timeline-stat .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .timeline-scroll {
      position: relative;
    }

    .timeline-line {
      position: absolute;
      left: 24px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, var(--accent), #a78bfa, var(--success));
      border-radius: 3px;
    }

    .timeline-day {
      position: relative;
      padding-left: 60px;
      margin-bottom: 24px;
    }

    .timeline-day:last-child { margin-bottom: 0; }

    .timeline-day-marker {
      position: absolute;
      left: 12px;
      top: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--panel);
      border: 3px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      z-index: 1;
    }

    .timeline-day-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--panel);
      border-radius: 10px;
      border: 1px solid var(--line);
    }

    .timeline-day-header .date {
      font-weight: 700;
      font-size: 15px;
    }

    .timeline-day-header .city-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--chip);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .timeline-day-header .city-tag .dot {
      width: 8px;
      height: 8px;
    }

    .timeline-day-header .hotel {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .timeline-events {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .timeline-event {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 10px;
      transition: all 0.2s;
    }

    .timeline-event:hover {
      border-color: var(--line-light);
      background: var(--panel-hover);
      transform: translateX(4px);
    }

    .timeline-event .icon {
      font-size: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--chip);
      border-radius: 8px;
      flex-shrink: 0;
    }

    .timeline-event .content {
      flex: 1;
      min-width: 0;
    }

    .timeline-event .event-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .timeline-event .event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .timeline-event .event-time {
      color: var(--text-secondary);
      font-weight: 600;
    }

    .timeline-event .event-type {
      background: var(--chip);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .timeline-event .ticket-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }

    .timeline-event .ticket-badge.pending {
      background: rgba(251, 191, 36, 0.15);
      color: var(--warning);
    }

    .timeline-event .ticket-badge.bought {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
    }

    .timeline-event .event-link {
      margin-left: auto;
    }

    /* City transition in timeline */
    .timeline-city-change {
      position: relative;
      padding-left: 60px;
      margin: 32px 0;
    }

    .timeline-city-change-marker {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 1;
      border: 3px solid;
    }

    .timeline-city-change-content {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: var(--panel);
      border-radius: 12px;
      border: 2px dashed var(--line);
    }

    .timeline-city-change-content .arrow {
      font-size: 20px;
      color: var(--muted);
    }

    .timeline-city-change-content .city-name {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Empty state */
    .timeline-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .timeline-empty .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Legend */
    .timeline-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px;
      background: var(--panel);
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--line);
    }

    .timeline-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .timeline-legend-item .icon {
      font-size: 16px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .wrap {
        grid-template-columns: 1fr;
      }
      aside {
        border-right: none;
        border-bottom: 1px solid var(--line);
      }
    }

    /* ==================== INLINE EDIT FORM ==================== */
    .event-edit-form {
      display: none;
      margin-top: 12px;
      padding: 14px;
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid var(--line-light);
    }

    .event.editing .event-edit-form {
      display: block;
    }

    .event.editing .event-view {
      display: none;
    }

    .event-view {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
    }

    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .edit-grid .full-width {
      grid-column: 1 / -1;
    }

    .edit-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .edit-field label {
      margin-bottom: 0;
    }

    .edit-field input,
    .edit-field select {
      width: 100%;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }

    .ticket-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 10px;
      background: var(--chip);
      border-radius: 6px;
      border: 1px solid var(--line);
      transition: all 0.2s;
    }

    .ticket-checkbox:hover {
      border-color: var(--line-light);
    }

    .ticket-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--success);
      cursor: pointer;
      padding: 0;
    }

    .ticket-checkbox span {
      font-size: 12px;
      font-weight: 500;
    }

    .ticket-checkbox.bought {
      background: rgba(52, 211, 153, 0.1);
      border-color: var(--success);
    }

    .ticket-checkbox.pending {
      background: rgba(251, 191, 36, 0.1);
      border-color: var(--warning);
    }

    .quick-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-icon {
      padding: 6px 8px;
      font-size: 14px;
      background: transparent;
      border: 1px solid var(--line);
    }

    .btn-icon:hover {
      background: var(--panel-hover);
      border-color: var(--line-light);
    }

    /* Handle for drag */
    .event-handle {
      cursor: grab;
      color: var(--muted);
      padding: 4px;
      margin-right: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .event:hover .event-handle {
      opacity: 1;
    }

    .event.sortable-ghost {
      opacity: 0.4;
      background: var(--accent-soft);
    }

    .event.sortable-chosen {
      background: var(--panel-hover);
      border-color: var(--accent);
    }

    /* Save confirmation animation */
    .event.just-saved {
      animation: saveFlash 0.5s ease-out;
      border-color: var(--success);
      box-shadow: 0 0 12px rgba(52, 211, 153, 0.4);
    }

    @keyframes saveFlash {
      0% {
        background: rgba(52, 211, 153, 0.3);
        transform: scale(1.01);
      }
      100% {
        background: var(--bg);
        transform: scale(1);
      }
    }

    /* Timeline drag support */
    .timeline-events.sortable-group .timeline-event {
      cursor: grab;
    }

    .timeline-event.sortable-ghost {
      opacity: 0.4;
      background: var(--accent-soft);
    }

    .timeline-event.sortable-chosen {
      background: var(--panel-hover);
      border-color: var(--accent);
    }

    .timeline-event .event-handle {
      cursor: grab;
      color: var(--muted);
      font-size: 12px;
      opacity: 0.5;
    }

    .timeline-event:hover .event-handle {
      opacity: 1;
    }

    /* Day type badges */
    .day-type-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .day-type-badge.arrival {
      background: rgba(91, 141, 239, 0.15);
      color: var(--accent);
    }

    .day-type-badge.departure {
      background: rgba(167, 139, 250, 0.15);
      color: #a78bfa;
    }

    .day-type-badge.full {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
    }

    /* City config: day types */
    .city-day-config {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed var(--line);
    }

    .day-type-selector {
      display: flex;
      gap: 6px;
    }

    .day-type-option {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid var(--line);
      background: var(--bg);
      transition: all 0.2s;
    }

    .day-type-option:hover {
      border-color: var(--line-light);
    }

    .day-type-option.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ==================== MULTI-SELECT CITY FILTER ==================== */
    .city-filter-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .city-filter-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }

    .city-filter-actions button {
      padding: 4px 10px;
      font-size: 11px;
    }

    .city-filter-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
      padding: 4px 0;
    }

    .city-filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .city-filter-item:hover {
      border-color: var(--line-light);
      background: var(--panel-hover);
    }

    .city-filter-item.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .city-filter-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .city-filter-item .city-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .city-filter-item .city-name {
      font-weight: 600;
      font-size: 13px;
    }

    .city-filter-item .city-nights {
      font-size: 11px;
      color: var(--muted);
    }

    .city-filter-count {
      font-size: 11px;
      color: var(--muted);
      padding: 4px 0;
    }
  </style>
</head>
<body>
<header>
  <h1>Trip Planner Local</h1>
  <div class="small">Todo local, drag & drop, timeline, export JSON + PDF</div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div style="font-weight:900;">Vista</div>
      <div class="tabs" style="margin-top:8px;">
        <div class="tab active" data-tab="all">Todo</div>
        <div class="tab" data-tab="city">Por ciudad</div>
        <div class="tab" data-tab="timeline">Timeline</div>
        <div class="tab" data-tab="tickets">Tickets</div>
      </div>

      <label>Filtrar ciudades</label>
      <div class="city-filter-container">
        <div class="city-filter-actions">
          <button id="btnSelectAll">Todas</button>
          <button id="btnSelectNone">Ninguna</button>
        </div>
        <div class="city-filter-list" id="cityFilterList"></div>
        <div class="city-filter-count" id="cityFilterCount"></div>
      </div>
      <div class="small">Seleccion√° una o m√°s ciudades para ver/editar.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small">Viaje</div>
          <div style="font-weight:900; font-size:14px;" id="tripTitle"></div>
          <div class="small" id="tripDates"></div>
        </div>
        <button class="primary" id="btnReset">Reset demo</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>Nombre del viaje</label>
          <input id="inpTripName" />
        </div>
        <div>
          <label>Fecha inicio</label>
          <input id="inpStartDate" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="primary" id="btnSaveTrip">Guardar</button>
        <button id="btnExport">Export JSON</button>
        <button class="primary" id="btnExportPdf">Export PDF</button>
        <label for="inpImport" class="tab" style="cursor:pointer;">Import JSON</label>
        <input id="inpImport" type="file" accept="application/json" style="display:none;" />
      </div>
      <div class="small">
        Si cambi√°s fecha inicio o noches, el sistema intenta preservar eventos por orden de d√≠as.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:900;">Ciudades</div>
        <button class="primary" id="btnAddCity">+ Ciudad</button>
      </div>
      <div class="small">Arrastr√° para reordenar. Los colores se reflejan en el calendario.</div>
      <div class="hr"></div>
      <div class="city-list" id="cityList"></div>
    </div>
  </aside>

  <main>
    <div id="viewAll" class="view"></div>
    <div id="viewCity" class="view" style="display:none;"></div>
    <div id="viewTimeline" class="view" style="display:none;">
      <div class="card">
        <div id="timelineContent"></div>
      </div>
    </div>
    <div id="viewTickets" class="view" style="display:none;"></div>
  </main>
</div>

<script>
  const STORAGE_KEY = "trip_planner_local_v2";

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function addDays(dateStr, n) {
    const d = new Date(dateStr + "T00:00:00");
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }

  function formatDateES(dateStr) {
    const d = new Date(dateStr + "T00:00:00");
    return d.toLocaleDateString("es-ES", { weekday:"short", year:"numeric", month:"short", day:"numeric" });
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ---------- Event Icons ----------
  function getEventIcon(type) {
    const icons = {
      'museo': 'üèõÔ∏è',
      'paseo': 'üö∂',
      'ticket': 'üéüÔ∏è',
      'comida': 'üçΩÔ∏è',
      'arquitectura': 'üèóÔ∏è',
      'barrio': 'üèòÔ∏è',
      'cultura': 'üé≠',
      'arte': 'üé®',
      'dise√±o': '‚ú®',
      'm√∫sica': 'üéµ',
      'log√≠stica': '‚úàÔ∏è',
      'hotel': 'üè®',
      'transporte': 'üöå',
      'compras': 'üõçÔ∏è',
      'naturaleza': 'üå≥',
      'playa': 'üèñÔ∏è',
      'nocturno': 'üåô',
      'foto': 'üì∏',
      'mirador': 'üëÄ',
      'religioso': '‚õ™',
      'mercado': 'üõí',
      'caf√©': '‚òï',
      'bar': 'üç∫',
      'show': 'üé™',
      'tour': 'üó∫Ô∏è',
      'default': 'üìç'
    };
    return icons[type?.toLowerCase()] || icons.default;
  }

  function ev(title, type, start, end, link, ticketRequired) {
    return {
      id: uid(),
      title,
      type,
      startTime: start || "",
      endTime: end || "",
      link: link || "",
      notes: "",
      ticketRequired: !!ticketRequired,
      ticketBought: false
    };
  }

  function defaultTrip() {
    const start = "2026-01-29";
    const cities = [
      { id: uid(), name:"Madrid (inicio)", color:"#4f7cff", nights:3, hotel:"UMusic Hotel Madrid", days: [] },
      { id: uid(), name:"Valencia", color:"#ff7a59", nights:3, hotel:"Only YOU Hotel Valencia", days: [] },
      { id: uid(), name:"Roma", color:"#3ddc97", nights:6, hotel:"Hotel Splendide Royal", days: [] },
      { id: uid(), name:"Florencia", color:"#c77dff", nights:2, hotel:"The Excelsior, a Luxury Collection Hotel, Florence", days: [] },
      { id: uid(), name:"Venecia", color:"#ffd166", nights:2, hotel:"Ca' di Dio Hotel", days: [] },
      { id: uid(), name:"Madrid (final)", color:"#4f7cff", nights:4, hotel:"Gran Hotel Ingl√©s", days: [] },
    ];

    const trip = { id: uid(), name:"Europa 2026", startDate:start, cities };
    regenerateDaysPreserve(trip, null); // genera d√≠as
    seedBasePlan(trip);                // carga planes base (eventos)
    return trip;
  }

  function loadTrip() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try {
      const trip = JSON.parse(raw);
      // Migrar datos viejos: regenerar d√≠as con la nueva l√≥gica de noches+1
      if (trip && trip.cities && trip.startDate) {
        const prevTrip = JSON.parse(JSON.stringify(trip)); // copia para preservar eventos
        regenerateDaysPreserve(trip, prevTrip);
        saveTrip(trip); // guardar versi√≥n migrada
      }
      return trip;
    } catch { return null; }
  }

  function saveTrip(trip) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trip));
  }

  // Preservar eventos al cambiar startDate / nights / orden ciudades
  // El d√≠a de viaje (salida de ciudad A / llegada a ciudad B) aparece en AMBAS ciudades
  function regenerateDaysPreserve(trip, prevTrip) {
    // Map previo: cityId -> array de arrays de eventos por √≠ndice de d√≠a
    const prevMap = new Map();
    if (prevTrip?.cities?.length) {
      for (const c of prevTrip.cities) {
        const dayEvents = (c.days || []).map(d => (d.events || []).map(e => ({...e})));
        prevMap.set(c.id, dayEvents);
      }
    }

    let cursor = trip.startDate;
    const totalCities = trip.cities.length;

    for (let cityIdx = 0; cityIdx < totalCities; cityIdx++) {
      const city = trip.cities[cityIdx];
      const isLastCity = cityIdx === totalCities - 1;
      const prevDayEvents = prevMap.get(city.id) || [];

      // Para ciudades que no son la √∫ltima, agregamos +1 d√≠a (d√≠a de viaje/partida)
      // que coincide con el d√≠a de llegada de la siguiente ciudad
      const numDays = isLastCity ? city.nights : city.nights + 1;
      const newDays = [];

      for (let i = 0; i < numDays; i++) {
        const date = addDays(cursor, i);
        const events = (prevDayEvents[i] ? prevDayEvents[i] : []).map(e => ({...e}));
        const label = i === 0 ? "Llegada" :
                      (i === numDays - 1 && !isLastCity) ? "Partida" :
                      "D√≠a " + (i + 1);
        newDays.push({ id: uid(), date, label, events });
      }

      city.days = newDays;
      // El cursor avanza solo por las noches (el d√≠a de partida es compartido con la llegada siguiente)
      cursor = addDays(cursor, city.nights);
    }
    trip.endDate = cursor;
  }

  function seedBasePlan(trip) {
    // Si ya hay eventos cargados, no pisa nada
    const hasAny = trip.cities.some(c => (c.days||[]).some(d => (d.events||[]).length > 0));
    if (hasAny) return;

    const byName = (n) => trip.cities.find(c => c.name === n);

    // MADRID INICIO
    const madridIni = byName("Madrid (inicio)");
    if (madridIni) {
      madridIni.days[0].events.push(ev("Llegada + Gran V√≠a + Malasa√±a", "paseo", "tarde", "", "", false));
      madridIni.days[1].events.push(ev("Museo Reina Sof√≠a (Guernica + recorrido moderno)", "museo", "10:00", "12:30", "https://www.museoreinasofia.es", true));
      madridIni.days[1].events.push(ev("Barrio de las Letras", "paseo", "13:30", "", "", false));
      madridIni.days[1].events.push(ev("Matadero Madrid", "cultura", "17:00", "", "https://www.mataderomadrid.org", false));
      madridIni.days[2].events.push(ev("Madrid R√≠o", "paseo", "11:00", "", "", false));
      madridIni.days[2].events.push(ev("Templo de Debod (atardecer)", "paseo", "18:00", "", "", false));
    }

    // VALENCIA
    const val = byName("Valencia");
    if (val) {
      val.days[0].events.push(ev("Ciudad de las Artes y las Ciencias (exterior)", "arquitectura", "11:00", "", "", false));
      val.days[0].events.push(ev("Marina de Valencia", "paseo", "16:30", "", "", false));
      val.days[1].events.push(ev("Ruzafa: arte urbano + caf√©s", "barrio", "11:00", "", "", false));
      val.days[2].events.push(ev("Jard√≠n del Turia (tramo central)", "paseo", "11:00", "", "", false));
    }

    // ROMA (con historia + entradas)
    const roma = byName("Roma");
    if (roma) {
      roma.days[0].events.push(ev("Coliseo por dentro + Foro + Palatino", "ticket", "09:30", "14:00", "https://www.coopculture.it", true));
      roma.days[1].events.push(ev("Museos Vaticanos + Capilla Sixtina", "ticket", "09:00", "13:30", "https://www.museivaticani.va", true));
      roma.days[1].events.push(ev("Bas√≠lica San Pedro + C√∫pula", "ticket", "14:30", "16:30", "https://www.vatican.va", true));
      roma.days[2].events.push(ev("Pante√≥n", "ticket", "11:00", "12:00", "https://www.museiitaliani.it", true));
      roma.days[2].events.push(ev("Piazza Navona + Trevi + Campo de‚Äô Fiori", "paseo", "12:30", "", "", false));
      roma.days[3].events.push(ev("Castel Sant‚ÄôAngelo", "ticket", "10:30", "12:30", "https://www.castelsantangelo.beniculturali.it", true));
      roma.days[3].events.push(ev("San Luigi dei Francesi (Caravaggio)", "arte", "16:30", "", "", false));
      roma.days[4].events.push(ev("MAXXI", "museo", "11:00", "13:00", "https://www.maxxi.art", false));
      roma.days[4].events.push(ev("Testaccio (barrio)", "barrio", "17:00", "", "", false));
      roma.days[5].events.push(ev("Trastevere + Gianicolo", "paseo", "16:00", "", "", false));
    }

    // FLORENCIA (Miguel √Ångel + Leonardo)
    const flo = byName("Florencia");
    if (flo) {
      flo.days[0].events.push(ev("Galleria dell‚ÄôAccademia (David de Miguel √Ångel)", "ticket", "09:00", "11:00", "https://www.galleriaaccademiafirenze.it", true));
      flo.days[0].events.push(ev("Duomo exterior + Piazza della Signoria", "paseo", "12:30", "", "", false));
      flo.days[1].events.push(ev("Galer√≠a Uffizi (Leonardo, Botticelli, Miguel √Ångel)", "ticket", "09:00", "12:30", "https://www.uffizi.it", true));
      flo.days[1].events.push(ev("Oltrarno + artesanos", "barrio", "16:30", "", "", false));
    }

    // VENECIA
    const ven = byName("Venecia");
    if (ven) {
      ven.days[0].events.push(ev("Dorsoduro + paseo libre", "paseo", "11:00", "", "", false));
      ven.days[0].events.push(ev("Carnaval (ambiente visual)", "cultura", "18:00", "", "", false));
      ven.days[1].events.push(ev("Peggy Guggenheim Collection", "ticket", "10:30", "12:30", "https://www.guggenheim-venice.it", true));
    }

    // MADRID FINAL (Bernab√©u + tortilla + festival)
    const madridFin = byName("Madrid (final)");
    if (madridFin) {
      madridFin.days[0].events.push(ev("Barrio de las Letras + caf√©s", "paseo", "12:00", "", "", false));
      madridFin.days[1].events.push(ev("Tour Bernab√©u", "ticket", "10:00", "12:00", "https://www.realmadrid.com/estadio-santiago-bernabeu", true));
      madridFin.days[1].events.push(ev("Tortilla cerca del Bernab√©u", "comida", "13:00", "", "", false));
      madridFin.days[2].events.push(ev("Madrid Design Festival (1 o 2 sedes)", "dise√±o", "12:00", "", "", false));
      madridFin.days[2].events.push(ev("M√∫sica (concierto o plan nocturno)", "m√∫sica", "21:00", "", "", false));
      madridFin.days[3].events.push(ev("Cierre + regreso", "log√≠stica", "ma√±ana", "", "", false));
    }
  }

  // ---------- State ----------
  let trip = loadTrip() || defaultTrip();
  // Si el usuario ya guard√≥ una versi√≥n sin eventos por alg√∫n bug previo, re-seed:
  seedBasePlan(trip);
  saveTrip(trip);

  // ---------- UI refs ----------
  const tripTitle = document.getElementById("tripTitle");
  const tripDates = document.getElementById("tripDates");
  const inpTripName = document.getElementById("inpTripName");
  const inpStartDate = document.getElementById("inpStartDate");
  const btnSaveTrip = document.getElementById("btnSaveTrip");
  const btnReset = document.getElementById("btnReset");
  const btnExport = document.getElementById("btnExport");
  const btnExportPdf = document.getElementById("btnExportPdf");
  const inpImport = document.getElementById("inpImport");

  const cityList = document.getElementById("cityList");
  const cityFilterList = document.getElementById("cityFilterList");
  const cityFilterCount = document.getElementById("cityFilterCount");
  const btnSelectAll = document.getElementById("btnSelectAll");
  const btnSelectNone = document.getElementById("btnSelectNone");
  const btnAddCity = document.getElementById("btnAddCity");

  // Track selected cities (array of city IDs)
  let selectedCityIds = [];

  const viewAll = document.getElementById("viewAll");
  const viewCity = document.getElementById("viewCity");
  const viewTimeline = document.getElementById("viewTimeline");
  const viewTickets = document.getElementById("viewTickets");

  // ---------- Tabs ----------
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      showTab(t.dataset.tab);
    });
  });

  function showTab(tab) {
    viewAll.style.display = tab === "all" ? "block" : "none";
    viewCity.style.display = tab === "city" ? "block" : "none";
    viewTimeline.style.display = tab === "timeline" ? "block" : "none";
    viewTickets.style.display = tab === "tickets" ? "block" : "none";
    if (tab === "timeline") renderTimeline();
  }

  // ---------- Filter ----------
  function getSelectedCities() {
    // If no cities selected, return all
    if (selectedCityIds.length === 0) {
      return trip.cities.map(c => c.id);
    }
    return selectedCityIds;
  }

  function isCitySelected(cityId) {
    const selected = getSelectedCities();
    return selected.includes(cityId);
  }

  function rebuildCityFilter() {
    cityFilterList.innerHTML = "";

    // Clean up selectedCityIds - remove IDs that no longer exist
    selectedCityIds = selectedCityIds.filter(id => trip.cities.some(c => c.id === id));

    // If no selection, select all by default
    if (selectedCityIds.length === 0) {
      selectedCityIds = trip.cities.map(c => c.id);
    }

    for (const c of trip.cities) {
      const isSelected = selectedCityIds.includes(c.id);
      const item = document.createElement("label");
      item.className = `city-filter-item ${isSelected ? 'selected' : ''}`;
      item.innerHTML = `
        <input type="checkbox" data-city-id="${c.id}" ${isSelected ? 'checked' : ''} />
        <div class="city-info">
          <span class="dot" style="background:${c.color}; width:10px; height:10px;"></span>
          <span class="city-name">${escapeHtml(c.name)}</span>
          <span class="city-nights">${c.nights} noches</span>
        </div>
      `;

      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', (evt) => {
        if (evt.target.checked) {
          if (!selectedCityIds.includes(c.id)) {
            selectedCityIds.push(c.id);
          }
          item.classList.add('selected');
        } else {
          selectedCityIds = selectedCityIds.filter(id => id !== c.id);
          item.classList.remove('selected');
        }
        updateCityFilterCount();
        triggerFilterChange();
      });

      cityFilterList.appendChild(item);
    }

    updateCityFilterCount();
  }

  function updateCityFilterCount() {
    const total = trip.cities.length;
    const selected = selectedCityIds.length;
    if (selected === total || selected === 0) {
      cityFilterCount.textContent = `Mostrando todas las ciudades (${total})`;
    } else {
      cityFilterCount.textContent = `Mostrando ${selected} de ${total} ciudades`;
    }
  }

  function triggerFilterChange() {
    renderAll();
    renderCity();
    renderTickets();
    if (document.querySelector('.tab.active')?.dataset.tab === "timeline") renderTimeline();
  }

  btnSelectAll.addEventListener("click", () => {
    selectedCityIds = trip.cities.map(c => c.id);
    rebuildCityFilter();
    triggerFilterChange();
  });

  btnSelectNone.addEventListener("click", () => {
    selectedCityIds = [];
    rebuildCityFilter();
    triggerFilterChange();
  });

  // ---------- Trip meta ----------
  function renderTripMeta() {
    tripTitle.textContent = trip.name;
    const totalNights = trip.cities.reduce((s,c) => s + c.nights, 0);
    const endExclusive = addDays(trip.startDate, totalNights);
    tripDates.textContent = `${formatDateES(trip.startDate)} ‚Üí ${formatDateES(addDays(endExclusive, -1))}`;
    inpTripName.value = trip.name;
    inpStartDate.value = trip.startDate;
  }

  btnSaveTrip.addEventListener("click", () => {
    const prev = JSON.parse(JSON.stringify(trip));

    trip.name = inpTripName.value.trim() || trip.name;
    trip.startDate = inpStartDate.value || trip.startDate;

    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  });

  btnReset.addEventListener("click", () => {
    trip = defaultTrip();
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  });

  btnExport.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(trip, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${trip.name.replace(/\s+/g,'_')}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  inpImport.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try {
      const obj = JSON.parse(text);
      trip = obj;
      // si el import trae ciudades sin days, regeneramos; si trae days, respetamos
      if (!trip.cities?.some(c => c.days?.length)) {
        const prev = null;
        regenerateDaysPreserve(trip, prev);
      }
      seedBasePlan(trip); // si vino vac√≠o, carga base
      saveTrip(trip);
      rebuildCityFilter();
      renderEverything();
    } catch {
      alert("JSON inv√°lido");
    }
    inpImport.value = "";
  });

  // ---------- Cities ----------
  function renderCities() {
    cityList.innerHTML = "";
    for (const c of trip.cities) {
      const item = document.createElement("div");
      item.className = "city-item";
      item.dataset.cityId = c.id;

      item.innerHTML = `
        <div class="row" style="gap:10px;">
          <div class="handle">‚ò∞</div>
          <span class="dot" style="background:${c.color}"></span>
          <div>
            <div class="name">${escapeHtml(c.name)}</div>
            <div class="small">${escapeHtml(c.hotel || "")} ¬∑ ${c.nights} noches</div>
          </div>
        </div>
        <div class="row">
          <button data-act="edit">Editar</button>
          <button class="danger" data-act="del">Borrar</button>
        </div>
      `;

      item.querySelector('[data-act="edit"]').addEventListener("click", () => editCity(c.id));
      item.querySelector('[data-act="del"]').addEventListener("click", () => deleteCity(c.id));
      cityList.appendChild(item);
    }

    Sortable.create(cityList, {
      handle: ".handle",
      animation: 150,
      onEnd: () => {
        const prev = JSON.parse(JSON.stringify(trip));
        const ids = Array.from(cityList.querySelectorAll(".city-item")).map(x => x.dataset.cityId);
        trip.cities = ids.map(id => trip.cities.find(c => c.id === id));

        regenerateDaysPreserve(trip, prev);
        saveTrip(trip);
        rebuildCityFilter();
        renderEverything();
      }
    });
  }

  btnAddCity.addEventListener("click", () => {
    const prev = JSON.parse(JSON.stringify(trip));
    const c = { id: uid(), name:"Nueva ciudad", color:"#7dd3fc", nights:2, hotel:"", days:[] };
    trip.cities.push(c);
    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
    editCity(c.id);
  });

  function editCity(cityId) {
    const prev = JSON.parse(JSON.stringify(trip));
    const c = trip.cities.find(x => x.id === cityId);
    if (!c) return;

    const name = prompt("Nombre ciudad:", c.name);
    if (name === null) return;
    c.name = name.trim() || c.name;

    const nightsStr = prompt("Noches:", String(c.nights));
    if (nightsStr === null) return;
    c.nights = Math.max(1, parseInt(nightsStr,10) || c.nights);

    const hotel = prompt("Hotel:", c.hotel || "");
    if (hotel !== null) c.hotel = hotel;

    const color = prompt("Color (hex), ej #4f7cff:", c.color);
    if (color !== null && /^#([0-9a-fA-F]{6})$/.test(color.trim())) c.color = color.trim();

    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  }

  function deleteCity(cityId) {
    const c = trip.cities.find(x => x.id === cityId);
    if (!c) return;
    if (!confirm(`Borrar ciudad "${c.name}"?`)) return;

    const prev = JSON.parse(JSON.stringify(trip));
    trip.cities = trip.cities.filter(x => x.id !== cityId);
    regenerateDaysPreserve(trip, prev);

    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  }

  // ---------- UI State Preservation ----------
  // Store open states to preserve across re-renders
  let preservedOpenDays = new Set();
  let preservedEditingEvents = new Set();
  let preservedOpenCities = new Set();

  function saveUIState() {
    // Save open day details
    preservedOpenDays = new Set();
    document.querySelectorAll('details[data-day-id]').forEach(det => {
      if (det.open) preservedOpenDays.add(det.dataset.dayId);
    });

    // Save open city details (in City view)
    preservedOpenCities = new Set();
    document.querySelectorAll('details[data-city-id]').forEach(det => {
      if (det.open) preservedOpenCities.add(det.dataset.cityId);
    });

    // Save editing events
    preservedEditingEvents = new Set();
    document.querySelectorAll('.event.editing').forEach(el => {
      preservedEditingEvents.add(el.dataset.eventId);
    });
  }

  function restoreUIState() {
    // Restore open day details
    document.querySelectorAll('details[data-day-id]').forEach(det => {
      if (preservedOpenDays.has(det.dataset.dayId)) {
        det.open = true;
      }
    });

    // Restore open city details
    document.querySelectorAll('details[data-city-id]').forEach(det => {
      if (preservedOpenCities.has(det.dataset.cityId)) {
        det.open = true;
      }
    });

    // Restore editing events
    document.querySelectorAll('.event').forEach(el => {
      if (preservedEditingEvents.has(el.dataset.eventId)) {
        el.classList.add('editing');
      }
    });
  }

  // ---------- Views ----------
  function dayDetails(city, day, openByDefault) {
    const det = document.createElement("details");
    det.dataset.dayId = day.id; // Track by day ID for state preservation
    det.open = !!openByDefault; // para que veas eventos sin tener que abrir todo
    det.innerHTML = `
      <summary>
        <span>${formatDateES(day.date)}</span>
        <span class="small">${escapeHtml(city.name)}</span>
      </summary>
    `;

    const box = document.createElement("div");
    box.style.marginTop = "10px";

    const btnRow = document.createElement("div");
    btnRow.className = "row";
    btnRow.innerHTML = `
      <button class="primary">+ Evento</button>
      <span class="small">Arrastr√° para reordenar o mover entre d√≠as.</span>
      <span class="pill small">${escapeHtml(city.hotel || "")}</span>
    `;
    btnRow.querySelector("button").addEventListener("click", () => {
      day.events.push(ev("Nuevo evento", "paseo", "", "", "", false));
      saveTrip(trip);
      renderEverything();
    });

    const events = document.createElement("div");
    events.className = "events";
    events.dataset.cityId = city.id;
    events.dataset.dayId = day.id;

    for (const e of day.events) {
      events.appendChild(eventCard(city, day, e));
    }

    box.appendChild(btnRow);
    box.appendChild(events);
    det.appendChild(box);

    wireDnD(events);
    return det;
  }

  // Lista de tipos de evento para el selector
  const EVENT_TYPES = [
    'paseo', 'museo', 'ticket', 'comida', 'arquitectura', 'barrio',
    'cultura', 'arte', 'dise√±o', 'm√∫sica', 'log√≠stica', 'hotel',
    'transporte', 'compras', 'naturaleza', 'playa', 'nocturno',
    'foto', 'mirador', 'religioso', 'mercado', 'caf√©', 'bar', 'show', 'tour'
  ];

  function eventCard(city, day, e) {
    const el = document.createElement("div");
    el.className = "event";
    el.dataset.eventId = e.id;
    el.dataset.cityId = city.id;
    el.dataset.dayId = day.id;

    const icon = getEventIcon(e.type);
    const timePart = e.startTime ? `${escapeHtml(e.startTime)}${e.endTime ? " ‚Äì "+escapeHtml(e.endTime) : ""}` : "";
    const linkPart = e.link ? `<a href="${escapeHtml(e.link)}" target="_blank" onclick="event.stopPropagation()">üîó</a>` : "";

    // Generar opciones del select de tipos
    const typeOptions = EVENT_TYPES.map(t =>
      `<option value="${t}" ${e.type === t ? 'selected' : ''}>${t}</option>`
    ).join('');

    el.innerHTML = `
      <div class="event-view">
        <div class="left" style="display:flex; align-items:flex-start; gap:8px;">
          <span class="event-handle" title="Arrastrar">‚ò∞</span>
          <div>
            <div class="title"><span class="icon">${icon}</span> ${escapeHtml(e.title)}</div>
            <div class="meta">
              <span class="type-badge">${escapeHtml(e.type || "evento")}</span>
              ${timePart ? `<span class="time">üïê ${timePart}</span>` : ""}
              ${linkPart}
            </div>
          </div>
        </div>
        <div class="quick-actions">
          ${e.ticketRequired ? `
            <label class="ticket-checkbox ${e.ticketBought ? 'bought' : 'pending'}" title="Click para cambiar estado">
              <input type="checkbox" data-act="ticket" ${e.ticketBought ? 'checked' : ''} />
              <span>${e.ticketBought ? '‚úì Comprado' : '‚ö† Pendiente'}</span>
            </label>
          ` : ''}
          <button class="btn-icon" data-act="edit" title="Editar">‚úèÔ∏è</button>
          <button class="btn-icon danger" data-act="del" title="Borrar">üóëÔ∏è</button>
        </div>
      </div>

      <div class="event-edit-form">
        <div class="edit-grid">
          <div class="edit-field full-width">
            <label>T√≠tulo</label>
            <input type="text" data-field="title" value="${escapeHtml(e.title)}" />
          </div>
          <div class="edit-field">
            <label>Tipo</label>
            <select data-field="type">
              <option value="">-- Seleccionar --</option>
              ${typeOptions}
            </select>
          </div>
          <div class="edit-field">
            <label>Link</label>
            <input type="url" data-field="link" value="${escapeHtml(e.link || '')}" placeholder="https://..." />
          </div>
          <div class="edit-field">
            <label>Hora inicio</label>
            <input type="text" data-field="startTime" value="${escapeHtml(e.startTime || '')}" placeholder="10:00 o 'tarde'" />
          </div>
          <div class="edit-field">
            <label>Hora fin</label>
            <input type="text" data-field="endTime" value="${escapeHtml(e.endTime || '')}" placeholder="14:00 (opcional)" />
          </div>
          <div class="edit-field">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" data-field="ticketRequired" ${e.ticketRequired ? 'checked' : ''} style="width:16px;height:16px;" />
              Requiere ticket/entrada
            </label>
          </div>
          <div class="edit-field">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" data-field="ticketBought" ${e.ticketBought ? 'checked' : ''} ${!e.ticketRequired ? 'disabled' : ''} style="width:16px;height:16px;" />
              Ticket comprado
            </label>
          </div>
        </div>
        <div class="edit-actions">
          <button class="primary" data-act="save">üíæ Guardar</button>
          <button data-act="cancel">Cancelar</button>
        </div>
      </div>
    `;

    // Event: Toggle ticket bought (quick action)
    const ticketCheckbox = el.querySelector('[data-act="ticket"]');
    if (ticketCheckbox) {
      ticketCheckbox.addEventListener("change", (evt) => {
        evt.stopPropagation();
        e.ticketBought = evt.target.checked;
        saveTrip(trip);
        // Update label
        const label = evt.target.closest('.ticket-checkbox');
        label.className = `ticket-checkbox ${e.ticketBought ? 'bought' : 'pending'}`;
        label.querySelector('span').textContent = e.ticketBought ? '‚úì Comprado' : '‚ö† Pendiente';
      });
    }

    // Event: Edit button - toggle edit mode
    el.querySelector('[data-act="edit"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      el.classList.toggle('editing');
    });

    // Event: Cancel editing
    el.querySelector('[data-act="cancel"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      el.classList.remove('editing');
      // Reset form values
      el.querySelector('[data-field="title"]').value = e.title;
      el.querySelector('[data-field="type"]').value = e.type || '';
      el.querySelector('[data-field="link"]').value = e.link || '';
      el.querySelector('[data-field="startTime"]').value = e.startTime || '';
      el.querySelector('[data-field="endTime"]').value = e.endTime || '';
      el.querySelector('[data-field="ticketRequired"]').checked = e.ticketRequired;
      el.querySelector('[data-field="ticketBought"]').checked = e.ticketBought;
    });

    // Event: Save changes
    el.querySelector('[data-act="save"]').addEventListener("click", (evt) => {
      evt.stopPropagation();

      const newTitle = el.querySelector('[data-field="title"]').value.trim();
      e.title = newTitle || e.title;
      e.type = el.querySelector('[data-field="type"]').value;
      e.link = el.querySelector('[data-field="link"]').value.trim();
      e.startTime = el.querySelector('[data-field="startTime"]').value.trim();
      e.endTime = el.querySelector('[data-field="endTime"]').value.trim();
      e.ticketRequired = el.querySelector('[data-field="ticketRequired"]').checked;
      e.ticketBought = el.querySelector('[data-field="ticketBought"]').checked;

      if (!e.ticketRequired) e.ticketBought = false;

      // Close the edit form
      el.classList.remove('editing');

      // Show save confirmation
      el.classList.add('just-saved');
      setTimeout(() => el.classList.remove('just-saved'), 1500);

      saveTrip(trip);
      renderEverything(false);
    });

    // Event: ticketRequired checkbox controls ticketBought
    el.querySelector('[data-field="ticketRequired"]').addEventListener("change", (evt) => {
      const ticketBoughtCheckbox = el.querySelector('[data-field="ticketBought"]');
      ticketBoughtCheckbox.disabled = !evt.target.checked;
      if (!evt.target.checked) ticketBoughtCheckbox.checked = false;
    });

    // Event: Delete
    el.querySelector('[data-act="del"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      if (!confirm(`¬øBorrar "${e.title}"?`)) return;
      for (const c of trip.cities) {
        for (const d of c.days) {
          const idx = d.events.findIndex(x => x.id === e.id);
          if (idx >= 0) {
            d.events.splice(idx, 1);
            saveTrip(trip);
            renderEverything();
            return;
          }
        }
      }
    });

    return el;
  }

  function renderAll() {
    viewAll.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Todo el viaje</div>`;
    viewAll.appendChild(card);

    const daysWrap = document.createElement("div");
    daysWrap.className = "days";
    card.appendChild(daysWrap);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;

      const head = document.createElement("div");
      head.className = "city-pill";
      head.innerHTML = `<span class="dot" style="background:${c.color}"></span>
                        <div><b>${escapeHtml(c.name)}</b> <span class="small">¬∑ ${c.nights} noches ¬∑ ${escapeHtml(c.hotel||"")}</span></div>`;
      daysWrap.appendChild(head);

      c.days.forEach((d, idx) => {
        // Abrimos por default el primer d√≠a de cada ciudad para que veas eventos al toque
        daysWrap.appendChild(dayDetails(c, d, idx === 0));
      });
    }
  }

  function renderCity() {
    viewCity.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Vista por ciudad</div>`;
    viewCity.appendChild(card);

    const list = document.createElement("div");
    list.className = "days";
    card.appendChild(list);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;

      const det = document.createElement("details");
      det.dataset.cityId = c.id; // Track by city ID for state preservation
      det.open = true;
      det.innerHTML = `
        <summary>
          <span class="row" style="gap:10px;">
            <span class="dot" style="background:${c.color}"></span>
            <span>${escapeHtml(c.name)}</span>
            <span class="small">${escapeHtml(c.hotel||"")} ¬∑ ${c.nights} noches</span>
          </span>
          <span class="small">click para colapsar</span>
        </summary>
      `;
      const inner = document.createElement("div");
      inner.className = "days";
      inner.style.marginTop = "10px";
      det.appendChild(inner);

      c.days.forEach((d, idx) => inner.appendChild(dayDetails(c, d, idx === 0)));
      list.appendChild(det);
    }
  }

  function renderTickets() {
    viewTickets.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Tickets</div>
                      <div class="small">Marc√° comprado. Links en cada evento.</div>`;
    viewTickets.appendChild(card);

    const wrap = document.createElement("div");
    wrap.className = "days";
    card.appendChild(wrap);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;
      for (const d of c.days) {
        for (const e of d.events) {
          if (!e.ticketRequired) continue;

          const t = document.createElement("div");
          t.className = "ticket";
          t.innerHTML = `
            <input type="checkbox" ${e.ticketBought ? "checked" : ""} />
            <div style="flex:1;">
              <div class="tname">${escapeHtml(e.title)}</div>
              <div class="small">${escapeHtml(c.name)} ¬∑ ${formatDateES(d.date)} ¬∑ ${escapeHtml(e.startTime||"")}</div>
              ${e.link ? `<div class="small"><a href="${escapeHtml(e.link)}" target="_blank">Link</a></div>` : ""}
            </div>
          `;
          t.querySelector("input").addEventListener("change", (ev) => {
            e.ticketBought = ev.target.checked;
            saveTrip(trip);
          });
          wrap.appendChild(t);
        }
      }
    }

    if (!wrap.children.length) {
      const empty = document.createElement("div");
      empty.className = "small";
      empty.textContent = "No hay tickets marcados como requeridos todav√≠a.";
      wrap.appendChild(empty);
    }
  }

  // ---------- Drag & drop ----------
  function wireDnD(container) {
    Sortable.create(container, {
      group: "events",
      handle: ".event-handle",
      animation: 150,
      ghostClass: "sortable-ghost",
      chosenClass: "sortable-chosen",
      onEnd: (evt) => {
        const fromCityId = evt.from.dataset.cityId;
        const fromDayId  = evt.from.dataset.dayId;
        const toCityId   = evt.to.dataset.cityId;
        const toDayId    = evt.to.dataset.dayId;
        const eventId    = evt.item.dataset.eventId;

        const fromCity = trip.cities.find(c => c.id === fromCityId);
        const toCity   = trip.cities.find(c => c.id === toCityId);
        const fromDay  = fromCity.days.find(d => d.id === fromDayId);
        const toDay    = toCity.days.find(d => d.id === toDayId);

        const moved = fromDay.events.find(e => e.id === eventId);
        fromDay.events = fromDay.events.filter(e => e.id !== eventId);

        const newIndex = evt.newIndex;
        toDay.events.splice(newIndex, 0, moved);

        saveTrip(trip);
        renderEverything(false);
      }
    });
  }

  // Wire drag & drop for timeline events
  function wireTimelineDnD() {
    document.querySelectorAll('.timeline-events[data-day-id]').forEach(container => {
      Sortable.create(container, {
        group: "timeline-events",
        handle: ".event-handle",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        onEnd: (evt) => {
          const fromDayId = evt.from.dataset.dayId;
          const toDayId = evt.to.dataset.dayId;
          const eventId = evt.item.dataset.eventId;

          // Find the days
          let fromDay = null, toDay = null;
          for (const c of trip.cities) {
            for (const d of c.days) {
              if (d.id === fromDayId) fromDay = d;
              if (d.id === toDayId) toDay = d;
            }
          }

          if (!fromDay || !toDay) return;

          const moved = fromDay.events.find(e => e.id === eventId);
          if (!moved) return;

          fromDay.events = fromDay.events.filter(e => e.id !== eventId);
          toDay.events.splice(evt.newIndex, 0, moved);

          saveTrip(trip);
          renderTimeline();
        }
      });
    });
  }

  // ---------- Timeline Continua ----------
  // Determinar tipo de d√≠a (llegada, partida, completo)
  function getDayType(city, dayIndex) {
    const isFirstDay = dayIndex === 0;
    const isLastDay = dayIndex === city.days.length - 1;

    // Si tiene firstDayType o lastDayType definido en la ciudad, usarlo
    if (isFirstDay && city.firstDayType) return city.firstDayType;
    if (isLastDay && city.lastDayType) return city.lastDayType;

    // Default: primer d√≠a es llegada, √∫ltimo es partida
    if (isFirstDay) return 'arrival';
    if (isLastDay) return 'departure';
    return 'full';
  }

  function getDayTypeBadge(dayType) {
    switch(dayType) {
      case 'arrival': return '<span class="day-type-badge arrival">üõ¨ Llegada</span>';
      case 'departure': return '<span class="day-type-badge departure">üõ´ Partida</span>';
      case 'full': return '<span class="day-type-badge full">üìÖ D√≠a completo</span>';
      default: return '';
    }
  }

  function renderTimeline() {
    const container = document.getElementById("timelineContent");
    if (!container) return;

    // Recopilar todos los d√≠as con su ciudad
    const allDays = [];
    const dateToNumber = new Map(); // Mapea fecha -> n√∫mero de d√≠a
    let uniqueDayCount = 0;

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;
      for (let i = 0; i < c.days.length; i++) {
        const d = c.days[i];
        const dayType = getDayType(c, i);

        // Asignar n√∫mero de d√≠a basado en la fecha √∫nica
        if (!dateToNumber.has(d.date)) {
          uniqueDayCount++;
          dateToNumber.set(d.date, uniqueDayCount);
        }
        const dayNum = dateToNumber.get(d.date);

        allDays.push({ city: c, day: d, dayNum, dayIndex: i, dayType });
      }
    }

    // Calcular estad√≠sticas - usar d√≠as √∫nicos, no total de entries
    const totalDays = uniqueDayCount;
    const totalEvents = allDays.reduce((sum, item) => sum + (item.day.events?.length || 0), 0);
    const ticketsPending = allDays.reduce((sum, item) =>
      sum + (item.day.events?.filter(e => e.ticketRequired && !e.ticketBought).length || 0), 0);
    const citiesCount = getSelectedCities().length;

    // Construir HTML
    let html = `
      <div class="timeline-container">
        <div class="timeline-header">
          <h2>üóìÔ∏è Timeline del viaje</h2>
          <div class="timeline-stats">
            <div class="timeline-stat">
              <div class="value">${totalDays}</div>
              <div class="label">D√≠as</div>
            </div>
            <div class="timeline-stat">
              <div class="value">${citiesCount}</div>
              <div class="label">Ciudades</div>
            </div>
            <div class="timeline-stat">
              <div class="value">${totalEvents}</div>
              <div class="label">Eventos</div>
            </div>
            ${ticketsPending > 0 ? `
            <div class="timeline-stat">
              <div class="value" style="color: var(--warning)">${ticketsPending}</div>
              <div class="label">Tickets pendientes</div>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="timeline-legend">
          <div class="timeline-legend-item"><span class="icon">üèõÔ∏è</span> Museo</div>
          <div class="timeline-legend-item"><span class="icon">üö∂</span> Paseo</div>
          <div class="timeline-legend-item"><span class="icon">üéüÔ∏è</span> Ticket</div>
          <div class="timeline-legend-item"><span class="icon">üçΩÔ∏è</span> Comida</div>
          <div class="timeline-legend-item"><span class="icon">üé≠</span> Cultura</div>
          <div class="timeline-legend-item"><span class="icon">üé®</span> Arte</div>
          <div class="timeline-legend-item"><span class="icon">üèóÔ∏è</span> Arquitectura</div>
          <div class="timeline-legend-item"><span class="icon">üèòÔ∏è</span> Barrio</div>
          <div class="timeline-legend-item"><span class="icon">‚úàÔ∏è</span> Log√≠stica</div>
        </div>

        <div class="small" style="margin-bottom:16px; padding:10px; background:var(--panel); border-radius:8px; border:1px solid var(--line);">
          üí° <b>Tip:</b> Arrastr√° eventos con el √≠cono ‚ò∞ para reordenarlos o moverlos entre d√≠as.
          Los d√≠as de llegada/partida indican transiciones entre ciudades.
        </div>

        <div class="timeline-scroll">
          <div class="timeline-line"></div>
    `;

    if (allDays.length === 0) {
      html += `
        <div class="timeline-empty">
          <div class="icon">üó∫Ô∏è</div>
          <div>No hay d√≠as para mostrar</div>
          <div class="small">Agreg√° ciudades y eventos para ver tu timeline</div>
        </div>
      `;
    } else {
      let lastCityId = null;

      for (const { city, day, dayNum, dayIndex, dayType } of allDays) {
        // Si cambi√≥ la ciudad, mostrar transici√≥n
        if (lastCityId !== null && lastCityId !== city.id) {
          html += `
            <div class="timeline-city-change">
              <div class="timeline-city-change-marker" style="background: ${city.color}; border-color: ${city.color}; color: white;">
                üöÄ
              </div>
              <div class="timeline-city-change-content">
                <span class="city-name">
                  <span class="dot" style="background: ${city.color}; box-shadow: 0 0 8px ${city.color}"></span>
                  Llegada a ${escapeHtml(city.name)}
                </span>
                <span class="arrow">‚Üí</span>
                <span class="small">${city.nights} noches</span>
              </div>
            </div>
          `;
        }
        lastCityId = city.id;

        // D√≠a
        html += `
          <div class="timeline-day">
            <div class="timeline-day-marker" style="border-color: ${city.color}">${dayNum}</div>
            <div class="timeline-day-header">
              <span class="date">${formatDateES(day.date)}</span>
              <span class="city-tag">
                <span class="dot" style="background: ${city.color}; box-shadow: 0 0 6px ${city.color}"></span>
                ${escapeHtml(city.name)}
              </span>
              ${getDayTypeBadge(dayType)}
              ${city.hotel ? `<span class="hotel">üè® ${escapeHtml(city.hotel)}</span>` : ''}
            </div>
            <div class="timeline-events" data-day-id="${day.id}" data-city-id="${city.id}">
        `;

        if (!day.events || day.events.length === 0) {
          html += `
            <div class="timeline-event timeline-event-empty" style="opacity: 0.6;">
              <div class="icon">üìù</div>
              <div class="content">
                <div class="event-title" style="color: var(--muted)">Sin eventos planificados</div>
                <div class="event-meta">${dayType === 'arrival' ? 'D√≠a de llegada - tarde libre' : dayType === 'departure' ? 'D√≠a de partida - ma√±ana libre' : 'D√≠a libre o por planificar'}</div>
              </div>
            </div>
          `;
        } else {
          for (const e of day.events) {
            const icon = getEventIcon(e.type);
            const timePart = e.startTime ? `${escapeHtml(e.startTime)}${e.endTime ? ' ‚Äì ' + escapeHtml(e.endTime) : ''}` : '';

            let ticketBadge = '';
            if (e.ticketRequired) {
              ticketBadge = e.ticketBought
                ? `<span class="ticket-badge bought">‚úì Comprado</span>`
                : `<span class="ticket-badge pending">‚ö† Pendiente</span>`;
            }

            html += `
              <div class="timeline-event" data-event-id="${e.id}">
                <span class="event-handle" title="Arrastrar">‚ò∞</span>
                <div class="icon">${icon}</div>
                <div class="content">
                  <div class="event-title">${escapeHtml(e.title)}</div>
                  <div class="event-meta">
                    ${timePart ? `<span class="event-time">üïê ${timePart}</span>` : ''}
                    <span class="event-type">${escapeHtml(e.type || 'evento')}</span>
                    ${ticketBadge}
                  </div>
                </div>
                ${e.link ? `<a href="${escapeHtml(e.link)}" target="_blank" class="event-link" title="Abrir link">üîó</a>` : ''}
              </div>
            `;
          }
        }

        html += `
            </div>
          </div>
        `;
      }
    }

    html += `
        </div>
      </div>
    `;

    container.innerHTML = html;

    // Wire drag & drop after rendering
    wireTimelineDnD();
  }

  // ---------- PDF export ----------
  btnExportPdf.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const margin = 40;
    let y = margin;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(trip.name || "Viaje", margin, y);
    y += 18;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const totalNights = trip.cities.reduce((s,c)=>s+c.nights,0);
    const endExclusive = addDays(trip.startDate, totalNights);
    doc.text(`${formatDateES(trip.startDate)} ‚Üí ${formatDateES(addDays(endExclusive, -1))}`, margin, y);
    y += 18;

    // Itinerario tabla
    const rows = [];
    for (const c of trip.cities) {
      for (const d of c.days) {
        const evs = (d.events||[])
          .map(e => {
            const t = e.startTime ? `${e.startTime}${e.endTime ? "‚Äì"+e.endTime : ""}` : "";
            const ticket = e.ticketRequired ? (e.ticketBought ? " (Ticket comprado)" : " (Ticket pendiente)") : "";
            return `‚Ä¢ ${t ? t+" " : ""}${e.title}${ticket}`;
          })
          .join("\n");
        rows.push([
          c.name,
          d.date,
          d.date ? formatDateES(d.date) : "",
          c.hotel || "",
          evs || ""
        ]);
      }
    }

    doc.autoTable({
      startY: y,
      head: [["Ciudad", "Fecha", "D√≠a", "Hotel", "Eventos"]],
      body: rows,
      styles: { fontSize: 8, cellPadding: 4, overflow: "linebreak" },
      headStyles: { fillColor: [27, 32, 48] },
      columnStyles: {
        0: { cellWidth: 80 },
        1: { cellWidth: 55 },
        2: { cellWidth: 90 },
        3: { cellWidth: 120 },
        4: { cellWidth: 170 }
      },
      margin: { left: margin, right: margin }
    });

    // Tickets tabla
    const tickets = [];
    for (const c of trip.cities) {
      for (const d of c.days) {
        for (const e of d.events) {
          if (!e.ticketRequired) continue;
          tickets.push([
            c.name,
            formatDateES(d.date),
            e.title,
            e.ticketBought ? "Comprado" : "Pendiente",
            e.link || ""
          ]);
        }
      }
    }

    doc.addPage();
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Tickets", margin, margin);

    doc.autoTable({
      startY: margin + 12,
      head: [["Ciudad", "Fecha", "Lugar/Evento", "Estado", "Link"]],
      body: tickets.length ? tickets : [["-", "-", "No hay tickets marcados", "-", "-"]],
      styles: { fontSize: 8, cellPadding: 4, overflow: "linebreak" },
      headStyles: { fillColor: [27, 32, 48] },
      columnStyles: { 0:{cellWidth:80}, 1:{cellWidth:90}, 2:{cellWidth:180}, 3:{cellWidth:70}, 4:{cellWidth:120} },
      margin: { left: margin, right: margin }
    });

    doc.save(`${(trip.name||"viaje").replace(/\s+/g,"_")}.pdf`);
  });

  // ---------- Render orchestrator ----------
  function renderEverything(renderCal = true) {
    // Save UI state before re-rendering
    saveUIState();

    renderTripMeta();
    renderCities();
    rebuildCityFilter();
    renderAll();
    renderCity();
    renderTickets();
    const active = document.querySelector(".tab.active")?.dataset.tab || "all";
    if (active === "timeline" && renderCal) renderTimeline();

    // Restore UI state after rendering
    restoreUIState();
  }

  // ---------- Init ----------
  rebuildCityFilter();
  renderEverything();

</script>
</body>
</html>
