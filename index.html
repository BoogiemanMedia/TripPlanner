<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trip Planner Local</title>

  <!-- Drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <!-- Calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- Maps - Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --panel-hover: #f0f2f5;
      --muted: #6b7280;
      --text: #1f2937;
      --text-secondary: #4b5563;
      --line: #e5e7eb;
      --line-light: #d1d5db;
      --chip: #f3f4f6;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 16px;
      align-items: center;
      background: var(--panel);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .wrap {
      display: grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 60px);
      overflow: hidden;
    }

    aside {
      border-right: 1px solid var(--line);
      padding: 16px;
      background: var(--panel);
      overflow-y: auto;
      height: 100%;
    }

    main {
      padding: 20px;
      background: var(--bg);
      overflow-y: auto;
      height: 100%;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card:hover { border-color: var(--line-light); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      display: block;
    }

    input, select, textarea, button {
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      padding: 10px 12px;
      font-size: 13px;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: var(--panel-hover); }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    button.primary:hover { background: #2563eb; }
    button.danger {
      background: #fef2f2;
      border-color: #fecaca;
      color: var(--danger);
    }
    button.danger:hover { background: #fee2e2; }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
    }
    .tab {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); background: var(--panel-hover); }
    .tab.active {
      background: var(--chip);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .city-pill {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--chip);
      display: flex;
      gap: 10px;
      align-items: center;
      transition: all 0.2s;
    }
    .city-pill:hover { border-color: var(--line-light); }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      display: inline-block;
      flex-shrink: 0;
      box-shadow: 0 0 8px currentColor;
    }

    .city-list { display: flex; flex-direction: column; gap: 10px; }

    .city-item {
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .city-item:hover { border-color: var(--line-light); background: var(--panel-hover); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .city-item .handle { cursor: grab; color: var(--muted); font-size: 14px; }
    .city-item .name { font-weight: 700; }

    .days { display: flex; flex-direction: column; gap: 12px; }

    details {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      padding: 12px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    details:hover { border-color: var(--line-light); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    details[open] { background: var(--panel); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

    summary {
      cursor: pointer;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      padding: 4px 0;
      list-style: none;
    }
    summary::-webkit-details-marker { display: none; }
    summary::before {
      content: "‚ñ∏";
      color: var(--muted);
      transition: transform 0.2s;
      margin-right: 8px;
    }
    details[open] summary::before { transform: rotate(90deg); }

    .events {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-left: 20px;
      border-left: 2px solid var(--line);
    }

    .event {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .event:hover {
      border-color: var(--line-light);
      background: var(--panel-hover);
      transform: translateX(2px);
    }
    .event .left { display: flex; flex-direction: column; gap: 6px; }
    .event .title {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .event .title .icon { font-size: 16px; }
    .event .meta {
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .event .meta .type-badge {
      background: var(--chip);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .event .meta .time {
      color: var(--text-secondary);
      font-weight: 500;
    }
    .event .meta .ticket-status {
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }
    .event .meta .ticket-status.pending {
      background: rgba(251, 191, 36, 0.15);
      color: var(--warning);
    }
    .event .meta .ticket-status.bought {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
    }
    .event .right { display: flex; gap: 6px; align-items: center; }

    a {
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s;
    }
    a:hover { opacity: 0.8; }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .hr { height: 1px; background: var(--line); margin: 14px 0; }

    .ticket {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .ticket:hover { border-color: var(--line-light); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .ticket .tname { font-weight: 700; }
    .ticket input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--success);
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--bg);
      font-size: 12px;
    }

    /* ==================== TIMELINE CONTINUA ==================== */
    .timeline-container {
      padding: 20px 0;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--line);
    }

    .timeline-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    .timeline-stats {
      display: flex;
      gap: 20px;
    }

    .timeline-stat {
      text-align: center;
    }

    .timeline-stat .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }

    .timeline-stat .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .timeline-scroll {
      position: relative;
    }

    .timeline-line {
      position: absolute;
      left: 24px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, var(--accent), #a78bfa, var(--success));
      border-radius: 3px;
    }

    .timeline-day {
      position: relative;
      padding-left: 60px;
      margin-bottom: 8px;
      padding-top: 12px;
      padding-bottom: 12px;
      padding-right: 16px;
      border-radius: 12px;
      /* El color de fondo se aplica inline con el color de la ciudad */
    }

    .timeline-day:last-child { margin-bottom: 0; }

    .timeline-day-marker {
      position: absolute;
      left: 12px;
      top: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      border: 3px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 800;
      color: #1a1a2e;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .timeline-day-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
    }

    .timeline-day-header .date {
      font-weight: 700;
      font-size: 15px;
      color: white;
    }

    .timeline-day-header .city-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      color: white;
    }

    .timeline-day-header .city-tag .dot {
      width: 8px;
      height: 8px;
      background: white !important;
      box-shadow: 0 0 6px white !important;
    }

    .timeline-day-header .hotel {
      margin-left: auto;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }

    .timeline-events {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .timeline-event {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.95);
      border: none;
      color: #1a1a2e;
      border-radius: 10px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .timeline-event:hover {
      background: white;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .timeline-event .icon {
      font-size: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f5;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .timeline-event .content {
      flex: 1;
      min-width: 0;
    }

    .timeline-event .event-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
      color: #1a1a2e;
    }

    .timeline-event .event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: #666;
    }

    .timeline-event .event-time {
      color: #444;
      font-weight: 600;
    }

    .timeline-event .event-type {
      background: #e8e8f0;
      padding: 2px 8px;
      border-radius: 4px;
      color: #555;
    }

    .timeline-event .ticket-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }

    .timeline-event .ticket-badge.pending {
      background: rgba(234, 179, 8, 0.2);
      color: #b45309;
    }

    .timeline-event .ticket-badge.bought {
      background: rgba(34, 197, 94, 0.2);
      color: #15803d;
    }

    .timeline-event .event-link {
      margin-left: auto;
      color: #3b82f6;
    }

    .timeline-event .event-handle {
      color: #999;
    }

    .timeline-event.timeline-event-empty {
      background: rgba(255,255,255,0.5);
      border: 1px dashed rgba(0,0,0,0.15);
      box-shadow: none;
    }

    /* City transition in timeline */
    .timeline-city-change {
      position: relative;
      padding-left: 60px;
      margin: 16px 0;
    }

    .timeline-city-change-marker {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 1;
      border: 3px solid;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .timeline-city-change-content {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 20px;
      background: linear-gradient(135deg, var(--panel) 0%, var(--bg) 100%);
      border-radius: 12px;
      border: 2px dashed var(--line-light);
    }

    .timeline-city-change-content .arrow {
      font-size: 24px;
      color: var(--accent);
    }

    .timeline-city-change-content .city-name {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    /* Empty state */
    .timeline-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .timeline-empty .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Legend */
    .timeline-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px;
      background: var(--panel);
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--line);
    }

    .timeline-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .timeline-legend-item .icon {
      font-size: 16px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .wrap {
        grid-template-columns: 1fr;
      }
      aside {
        border-right: none;
        border-bottom: 1px solid var(--line);
      }
    }

    /* ==================== INLINE EDIT FORM ==================== */
    .event-edit-form {
      display: none;
      margin-top: 12px;
      padding: 14px;
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid var(--line-light);
    }

    .event.editing .event-edit-form {
      display: block;
    }

    .event.editing .event-view {
      display: none;
    }

    .event-view {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
    }

    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .edit-grid .full-width {
      grid-column: 1 / -1;
    }

    .edit-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .edit-field label {
      margin-bottom: 0;
    }

    .edit-field input,
    .edit-field select {
      width: 100%;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }

    .ticket-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 10px;
      background: var(--chip);
      border-radius: 6px;
      border: 1px solid var(--line);
      transition: all 0.2s;
    }

    .ticket-checkbox:hover {
      border-color: var(--line-light);
    }

    .ticket-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--success);
      cursor: pointer;
      padding: 0;
    }

    .ticket-checkbox span {
      font-size: 12px;
      font-weight: 500;
    }

    .ticket-checkbox.bought {
      background: rgba(52, 211, 153, 0.1);
      border-color: var(--success);
    }

    .ticket-checkbox.pending {
      background: rgba(251, 191, 36, 0.1);
      border-color: var(--warning);
    }

    .quick-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-icon {
      padding: 6px 8px;
      font-size: 14px;
      background: transparent;
      border: 1px solid var(--line);
    }

    .btn-icon:hover {
      background: var(--panel-hover);
      border-color: var(--line-light);
    }

    /* Handle for drag */
    .event-handle {
      cursor: grab;
      color: var(--muted);
      padding: 4px;
      margin-right: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .event:hover .event-handle {
      opacity: 1;
    }

    .event.sortable-ghost {
      opacity: 0.4;
      background: var(--accent-soft);
    }

    .event.sortable-chosen {
      background: var(--panel-hover);
      border-color: var(--accent);
    }

    /* Save confirmation animation */
    .event.just-saved {
      animation: saveFlash 0.5s ease-out;
      border-color: var(--success);
      box-shadow: 0 0 12px rgba(52, 211, 153, 0.4);
    }

    @keyframes saveFlash {
      0% {
        background: rgba(16, 185, 129, 0.2);
        transform: scale(1.01);
      }
      100% {
        background: var(--panel);
        transform: scale(1);
      }
    }

    /* Timeline drag support */
    .timeline-events.sortable-group .timeline-event {
      cursor: grab;
    }

    .timeline-event.sortable-ghost {
      opacity: 0.4;
      background: var(--accent-soft);
    }

    .timeline-event.sortable-chosen {
      background: var(--panel-hover);
      border-color: var(--accent);
    }

    .timeline-event .event-handle {
      cursor: grab;
      color: var(--muted);
      font-size: 12px;
      opacity: 0.5;
    }

    .timeline-event:hover .event-handle {
      opacity: 1;
    }

    /* Timeline event actions */
    .timeline-event-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .timeline-event:hover .timeline-event-actions {
      opacity: 1;
    }

    .timeline-event-actions .btn-icon {
      padding: 4px 6px;
      font-size: 12px;
      background: rgba(0,0,0,0.05);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timeline-event-actions .btn-icon:hover {
      background: rgba(0,0,0,0.1);
    }

    .timeline-event-actions .timeline-delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Event notes */
    .event-notes {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      padding: 6px 8px;
      background: rgba(0,0,0,0.04);
      border-radius: 4px;
      border-left: 2px solid rgba(0,0,0,0.1);
    }

    .event-notes-inline {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      padding: 4px 8px;
      background: var(--chip);
      border-radius: 4px;
      border-left: 2px solid var(--line);
    }

    /* Add event button in timeline */
    .timeline-add-event-btn {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: rgba(255,255,255,0.6);
      border: 1px dashed rgba(0,0,0,0.2);
      border-radius: 8px;
      color: #666;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timeline-add-event-btn:hover {
      background: rgba(255,255,255,0.9);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Timeline edit modal */
    .timeline-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .timeline-modal {
      background: var(--panel);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid var(--line);
    }

    .timeline-modal h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 700;
    }

    .timeline-modal textarea {
      width: 100%;
      resize: vertical;
      min-height: 60px;
    }

    /* Day type badges */
    .day-type-badge {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .day-type-badge.arrival {
      background: rgba(255,255,255,0.25);
      color: #fff;
    }

    .day-type-badge.departure {
      background: rgba(255,255,255,0.25);
      color: #fff;
    }

    .day-type-badge.full {
      background: rgba(255,255,255,0.25);
      color: #fff;
    }

    /* City config: day types */
    .city-day-config {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed var(--line);
    }

    .day-type-selector {
      display: flex;
      gap: 6px;
    }

    .day-type-option {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid var(--line);
      background: var(--bg);
      transition: all 0.2s;
    }

    .day-type-option:hover {
      border-color: var(--line-light);
    }

    .day-type-option.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ==================== MULTI-SELECT CITY FILTER ==================== */
    .city-filter-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .city-filter-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }

    .city-filter-actions button {
      padding: 4px 10px;
      font-size: 11px;
    }

    .city-filter-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
      padding: 4px 0;
    }

    .city-filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .city-filter-item:hover {
      border-color: var(--line-light);
      background: var(--panel-hover);
    }

    .city-filter-item.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .city-filter-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .city-filter-item .city-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .city-filter-item .city-name {
      font-weight: 600;
      font-size: 13px;
    }

    .city-filter-item .city-nights {
      font-size: 11px;
      color: var(--muted);
    }

    .city-filter-count {
      font-size: 11px;
      color: var(--muted);
      padding: 4px 0;
    }

    /* ==================== THEME TOGGLE ==================== */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .theme-toggle-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .theme-switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: var(--chip);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--line);
    }

    .theme-switch::before {
      content: '‚òÄÔ∏è';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: var(--panel);
      border-radius: 50%;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .theme-switch.dark::before {
      content: 'üåô';
      left: calc(100% - 24px);
    }

    .theme-switch.dark {
      background: #374151;
      border-color: #4b5563;
    }

    /* Dark theme variables */
    body.dark-theme {
      --bg: #0f1117;
      --panel: #1a1d24;
      --panel-hover: #22262f;
      --muted: #9ca3af;
      --text: #f3f4f6;
      --text-secondary: #d1d5db;
      --line: #2d3340;
      --line-light: #3d4451;
      --chip: #252a33;
      --accent: #60a5fa;
      --accent-soft: rgba(96, 165, 250, 0.15);
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
    }
  </style>
</head>
<body>
<header>
  <h1>Trip Planner Local</h1>
  <div class="small">Todo local, drag & drop, timeline, export JSON + PDF</div>
  <div class="theme-toggle">
    <span class="theme-toggle-label">Tema</span>
    <div class="theme-switch" id="themeSwitch" title="Cambiar tema"></div>
  </div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div style="font-weight:900;">Vista</div>
      <div class="tabs" style="margin-top:8px;">
        <div class="tab active" data-tab="all">Todo</div>
        <div class="tab" data-tab="city">Por ciudad</div>
        <div class="tab" data-tab="timeline">Timeline</div>
        <div class="tab" data-tab="calendar">üìÖ Calendario</div>
        <div class="tab" data-tab="map">üó∫Ô∏è Mapa</div>
        <div class="tab" data-tab="today">‚≠ê Hoy</div>
        <div class="tab" data-tab="tickets">Tickets</div>
      </div>

      <label>Filtrar ciudades</label>
      <div class="city-filter-container">
        <div class="city-filter-actions">
          <button id="btnSelectAll">Todas</button>
          <button id="btnSelectNone">Ninguna</button>
        </div>
        <div class="city-filter-list" id="cityFilterList"></div>
        <div class="city-filter-count" id="cityFilterCount"></div>
      </div>
      <div class="small">Seleccion√° una o m√°s ciudades para ver/editar.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small">Viaje</div>
          <div style="font-weight:900; font-size:14px;" id="tripTitle"></div>
          <div class="small" id="tripDates"></div>
        </div>
        <button class="primary" id="btnReset">Reset demo</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>Nombre del viaje</label>
          <input id="inpTripName" />
        </div>
        <div>
          <label>Fecha inicio</label>
          <input id="inpStartDate" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="primary" id="btnSaveTrip">Guardar</button>
        <button id="btnSaveFile" title="Guardar archivo para subir al servidor">üíæ Guardar Archivo</button>
        <button id="btnExport">Export JSON</button>
        <button class="primary" id="btnExportPdf">Export PDF</button>
        <label for="inpImport" class="tab" style="cursor:pointer;">Import JSON</label>
        <input id="inpImport" type="file" accept="application/json" style="display:none;" />
      </div>
      <div class="small" id="dataFileStatus" style="margin-top:6px;"></div>
      <div class="small">
        üí° Us√° "Guardar Archivo" para descargar <strong>trip-data.json</strong> y subirlo junto con index.html al servidor.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:900;">Ciudades</div>
        <button class="primary" id="btnAddCity">+ Ciudad</button>
      </div>
      <div class="small">Arrastr√° para reordenar. Los colores se reflejan en el calendario.</div>
      <div class="hr"></div>
      <div class="city-list" id="cityList"></div>
    </div>
  </aside>

  <main>
    <div id="viewAll" class="view"></div>
    <div id="viewCity" class="view" style="display:none;"></div>
    <div id="viewTimeline" class="view" style="display:none;">
      <div class="card">
        <div id="timelineContent"></div>
      </div>
    </div>
    <div id="viewCalendar" class="view" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2 style="margin:0;">üìÖ Calendario</h2>
          <button id="btnExportICS" class="primary">üì§ Exportar a Google Calendar</button>
        </div>
        <div id="calendarContainer"></div>
      </div>
    </div>
    <div id="viewMap" class="view" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <h2 style="margin:0;">üó∫Ô∏è Mapa</h2>
            <select id="mapCitySelector" style="padding:6px 12px; border-radius:8px; border:1px solid var(--line); background:var(--panel); font-size:14px;">
              <option value="all">Vista general del viaje</option>
            </select>
          </div>
          <div id="weatherInfo" class="weather-widget"></div>
        </div>
        <div id="mapContainer" style="height:500px; border-radius:12px; overflow:hidden;"></div>
        <div id="mapLegend" style="margin-top:12px;"></div>
        <div id="mapDaySelector" style="margin-top:12px; display:none;"></div>
      </div>
    </div>
    <div id="viewToday" class="view" style="display:none;">
      <div class="card">
        <div id="todayContent"></div>
      </div>
    </div>
    <div id="viewTickets" class="view" style="display:none;"></div>
  </main>
</div>

<script>
  const STORAGE_KEY = "trip_planner_local_v2";
  const THEME_KEY = "trip_planner_theme";

  // ---------- Theme Toggle ----------
  function initTheme() {
    const savedTheme = localStorage.getItem(THEME_KEY);
    const themeSwitch = document.getElementById('themeSwitch');

    if (savedTheme === 'dark') {
      document.body.classList.add('dark-theme');
      themeSwitch.classList.add('dark');
    }

    themeSwitch.addEventListener('click', toggleTheme);
  }

  function toggleTheme() {
    const themeSwitch = document.getElementById('themeSwitch');
    const isDark = document.body.classList.toggle('dark-theme');
    themeSwitch.classList.toggle('dark', isDark);
    localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
  }

  // Initialize theme on page load
  document.addEventListener('DOMContentLoaded', initTheme);

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function addDays(dateStr, n) {
    const d = new Date(dateStr + "T00:00:00");
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }

  function formatDateES(dateStr) {
    const d = new Date(dateStr + "T00:00:00");
    return d.toLocaleDateString("es-ES", { weekday:"short", year:"numeric", month:"short", day:"numeric" });
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ---------- Event Icons ----------
  function getEventIcon(type) {
    const icons = {
      'museo': 'üèõÔ∏è',
      'paseo': 'üö∂',
      'ticket': 'üéüÔ∏è',
      'comida': 'üçΩÔ∏è',
      'arquitectura': 'üèóÔ∏è',
      'barrio': 'üèòÔ∏è',
      'cultura': 'üé≠',
      'arte': 'üé®',
      'dise√±o': '‚ú®',
      'm√∫sica': 'üéµ',
      'log√≠stica': '‚úàÔ∏è',
      'hotel': 'üè®',
      'transporte': 'üöå',
      'compras': 'üõçÔ∏è',
      'naturaleza': 'üå≥',
      'playa': 'üèñÔ∏è',
      'nocturno': 'üåô',
      'foto': 'üì∏',
      'mirador': 'üëÄ',
      'religioso': '‚õ™',
      'mercado': 'üõí',
      'caf√©': '‚òï',
      'bar': 'üç∫',
      'show': 'üé™',
      'tour': 'üó∫Ô∏è',
      'default': 'üìç'
    };
    return icons[type?.toLowerCase()] || icons.default;
  }

  function ev(title, type, start, end, link, ticketRequired) {
    return {
      id: uid(),
      title,
      type,
      startTime: start || "",
      endTime: end || "",
      link: link || "",
      notes: "",
      ticketRequired: !!ticketRequired,
      ticketBought: false
    };
  }

  function defaultTrip() {
    const start = "2026-01-29";
    const cities = [
      { id: uid(), name:"Madrid (inicio)", color:"#4f7cff", nights:3, hotel:"UMusic Hotel Madrid", coords: {lat: 40.4168, lng: -3.7038}, days: [] },
      { id: uid(), name:"Valencia", color:"#ff7a59", nights:3, hotel:"Only YOU Hotel Valencia", coords: {lat: 39.4699, lng: -0.3763}, days: [] },
      { id: uid(), name:"Roma", color:"#3ddc97", nights:6, hotel:"Hotel Splendide Royal", coords: {lat: 41.9028, lng: 12.4964}, days: [] },
      { id: uid(), name:"Florencia", color:"#c77dff", nights:2, hotel:"The Excelsior, a Luxury Collection Hotel, Florence", coords: {lat: 43.7696, lng: 11.2558}, days: [] },
      { id: uid(), name:"Venecia", color:"#ffd166", nights:2, hotel:"Ca' di Dio Hotel", coords: {lat: 45.4408, lng: 12.3155}, days: [] },
      { id: uid(), name:"Madrid (final)", color:"#4f7cff", nights:4, hotel:"Gran Hotel Ingl√©s", coords: {lat: 40.4168, lng: -3.7038}, days: [] },
    ];

    const trip = { id: uid(), name:"Europa 2026", startDate:start, cities };
    regenerateDaysPreserve(trip, null); // genera d√≠as
    seedBasePlan(trip);                // carga planes base (eventos)
    return trip;
  }

  function loadTrip() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try {
      const trip = JSON.parse(raw);
      // Migrar datos viejos: regenerar d√≠as con la nueva l√≥gica de noches+1
      if (trip && trip.cities && trip.startDate) {
        const prevTrip = JSON.parse(JSON.stringify(trip)); // copia para preservar eventos
        regenerateDaysPreserve(trip, prevTrip);
        saveTrip(trip); // guardar versi√≥n migrada
      }
      return trip;
    } catch { return null; }
  }

  function saveTrip(trip) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trip));
  }

  // Try to load from trip-data.json file (for server deployment)
  async function loadTripFromFile() {
    try {
      const response = await fetch('trip-data.json?t=' + Date.now()); // cache bust
      if (!response.ok) return null;
      const data = await response.json();
      return data;
    } catch {
      return null;
    }
  }

  // Save trip data to downloadable file
  function saveTripToFile() {
    const dataStr = JSON.stringify(trip, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trip-data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Show confirmation
    const status = document.getElementById('dataFileStatus');
    status.innerHTML = '‚úÖ Archivo descargado! Subilo al servidor junto con index.html';
    status.style.color = 'var(--success)';
    setTimeout(() => { status.innerHTML = ''; }, 5000);
  }

  // Preservar eventos al cambiar startDate / nights / orden ciudades
  // El d√≠a de viaje (salida de ciudad A / llegada a ciudad B) aparece en AMBAS ciudades
  function regenerateDaysPreserve(trip, prevTrip) {
    // Map previo: cityId -> array de arrays de eventos por √≠ndice de d√≠a
    const prevMap = new Map();
    if (prevTrip?.cities?.length) {
      for (const c of prevTrip.cities) {
        const dayEvents = (c.days || []).map(d => (d.events || []).map(e => ({...e})));
        prevMap.set(c.id, dayEvents);
      }
    }

    let cursor = trip.startDate;
    const totalCities = trip.cities.length;

    for (let cityIdx = 0; cityIdx < totalCities; cityIdx++) {
      const city = trip.cities[cityIdx];
      const isLastCity = cityIdx === totalCities - 1;
      const prevDayEvents = prevMap.get(city.id) || [];

      // Para ciudades que no son la √∫ltima, agregamos +1 d√≠a (d√≠a de viaje/partida)
      // que coincide con el d√≠a de llegada de la siguiente ciudad
      const numDays = isLastCity ? city.nights : city.nights + 1;
      const newDays = [];

      for (let i = 0; i < numDays; i++) {
        const date = addDays(cursor, i);
        const events = (prevDayEvents[i] ? prevDayEvents[i] : []).map(e => ({...e}));
        const label = i === 0 ? "Llegada" :
                      (i === numDays - 1 && !isLastCity) ? "Partida" :
                      "D√≠a " + (i + 1);
        newDays.push({ id: uid(), date, label, events });
      }

      city.days = newDays;
      // El cursor avanza solo por las noches (el d√≠a de partida es compartido con la llegada siguiente)
      cursor = addDays(cursor, city.nights);
    }
    trip.endDate = cursor;
  }

  function seedBasePlan(trip) {
    // Si ya hay eventos cargados, no pisa nada
    const hasAny = trip.cities.some(c => (c.days||[]).some(d => (d.events||[]).length > 0));
    if (hasAny) return;

    const byName = (n) => trip.cities.find(c => c.name === n);

    // MADRID INICIO
    const madridIni = byName("Madrid (inicio)");
    if (madridIni) {
      madridIni.days[0].events.push(ev("Llegada + Gran V√≠a + Malasa√±a", "paseo", "tarde", "", "", false));
      madridIni.days[1].events.push(ev("Museo Reina Sof√≠a (Guernica + recorrido moderno)", "museo", "10:00", "12:30", "https://www.museoreinasofia.es", true));
      madridIni.days[1].events.push(ev("Barrio de las Letras", "paseo", "13:30", "", "", false));
      madridIni.days[1].events.push(ev("Matadero Madrid", "cultura", "17:00", "", "https://www.mataderomadrid.org", false));
      madridIni.days[2].events.push(ev("Madrid R√≠o", "paseo", "11:00", "", "", false));
      madridIni.days[2].events.push(ev("Templo de Debod (atardecer)", "paseo", "18:00", "", "", false));
    }

    // VALENCIA
    const val = byName("Valencia");
    if (val) {
      val.days[0].events.push(ev("Ciudad de las Artes y las Ciencias (exterior)", "arquitectura", "11:00", "", "", false));
      val.days[0].events.push(ev("Marina de Valencia", "paseo", "16:30", "", "", false));
      val.days[1].events.push(ev("Ruzafa: arte urbano + caf√©s", "barrio", "11:00", "", "", false));
      val.days[2].events.push(ev("Jard√≠n del Turia (tramo central)", "paseo", "11:00", "", "", false));
    }

    // ROMA (con historia + entradas)
    const roma = byName("Roma");
    if (roma) {
      roma.days[0].events.push(ev("Coliseo por dentro + Foro + Palatino", "ticket", "09:30", "14:00", "https://www.coopculture.it", true));
      roma.days[1].events.push(ev("Museos Vaticanos + Capilla Sixtina", "ticket", "09:00", "13:30", "https://www.museivaticani.va", true));
      roma.days[1].events.push(ev("Bas√≠lica San Pedro + C√∫pula", "ticket", "14:30", "16:30", "https://www.vatican.va", true));
      roma.days[2].events.push(ev("Pante√≥n", "ticket", "11:00", "12:00", "https://www.museiitaliani.it", true));
      roma.days[2].events.push(ev("Piazza Navona + Trevi + Campo de‚Äô Fiori", "paseo", "12:30", "", "", false));
      roma.days[3].events.push(ev("Castel Sant‚ÄôAngelo", "ticket", "10:30", "12:30", "https://www.castelsantangelo.beniculturali.it", true));
      roma.days[3].events.push(ev("San Luigi dei Francesi (Caravaggio)", "arte", "16:30", "", "", false));
      roma.days[4].events.push(ev("MAXXI", "museo", "11:00", "13:00", "https://www.maxxi.art", false));
      roma.days[4].events.push(ev("Testaccio (barrio)", "barrio", "17:00", "", "", false));
      roma.days[5].events.push(ev("Trastevere + Gianicolo", "paseo", "16:00", "", "", false));
    }

    // FLORENCIA (Miguel √Ångel + Leonardo)
    const flo = byName("Florencia");
    if (flo) {
      flo.days[0].events.push(ev("Galleria dell‚ÄôAccademia (David de Miguel √Ångel)", "ticket", "09:00", "11:00", "https://www.galleriaaccademiafirenze.it", true));
      flo.days[0].events.push(ev("Duomo exterior + Piazza della Signoria", "paseo", "12:30", "", "", false));
      flo.days[1].events.push(ev("Galer√≠a Uffizi (Leonardo, Botticelli, Miguel √Ångel)", "ticket", "09:00", "12:30", "https://www.uffizi.it", true));
      flo.days[1].events.push(ev("Oltrarno + artesanos", "barrio", "16:30", "", "", false));
    }

    // VENECIA
    const ven = byName("Venecia");
    if (ven) {
      ven.days[0].events.push(ev("Dorsoduro + paseo libre", "paseo", "11:00", "", "", false));
      ven.days[0].events.push(ev("Carnaval (ambiente visual)", "cultura", "18:00", "", "", false));
      ven.days[1].events.push(ev("Peggy Guggenheim Collection", "ticket", "10:30", "12:30", "https://www.guggenheim-venice.it", true));
    }

    // MADRID FINAL (Bernab√©u + tortilla + festival)
    const madridFin = byName("Madrid (final)");
    if (madridFin) {
      madridFin.days[0].events.push(ev("Barrio de las Letras + caf√©s", "paseo", "12:00", "", "", false));
      madridFin.days[1].events.push(ev("Tour Bernab√©u", "ticket", "10:00", "12:00", "https://www.realmadrid.com/estadio-santiago-bernabeu", true));
      madridFin.days[1].events.push(ev("Tortilla cerca del Bernab√©u", "comida", "13:00", "", "", false));
      madridFin.days[2].events.push(ev("Madrid Design Festival (1 o 2 sedes)", "dise√±o", "12:00", "", "", false));
      madridFin.days[2].events.push(ev("M√∫sica (concierto o plan nocturno)", "m√∫sica", "21:00", "", "", false));
      madridFin.days[3].events.push(ev("Cierre + regreso", "log√≠stica", "ma√±ana", "", "", false));
    }
  }

  // ---------- State ----------
  let trip = loadTrip() || defaultTrip();
  // Si el usuario ya guard√≥ una versi√≥n sin eventos por alg√∫n bug previo, re-seed:
  seedBasePlan(trip);
  saveTrip(trip);

  // Try to load from trip-data.json if localStorage was empty (for server deployment)
  async function tryLoadFromFile() {
    const localData = localStorage.getItem(STORAGE_KEY);
    // Only try to load from file if localStorage is empty or very basic
    if (!localData || localData.length < 100) {
      const fileTrip = await loadTripFromFile();
      if (fileTrip && fileTrip.cities && fileTrip.cities.length > 0) {
        trip = fileTrip;
        saveTrip(trip);
        rebuildCityFilter();
        renderEverything();
        const status = document.getElementById('dataFileStatus');
        if (status) {
          status.innerHTML = 'üìÇ Datos cargados desde trip-data.json';
          status.style.color = 'var(--accent)';
        }
      }
    }
  }

  // Try loading from file after initial render
  tryLoadFromFile();

  // ---------- UI refs ----------
  const tripTitle = document.getElementById("tripTitle");
  const tripDates = document.getElementById("tripDates");
  const inpTripName = document.getElementById("inpTripName");
  const inpStartDate = document.getElementById("inpStartDate");
  const btnSaveTrip = document.getElementById("btnSaveTrip");
  const btnSaveFile = document.getElementById("btnSaveFile");
  const btnReset = document.getElementById("btnReset");
  const btnExport = document.getElementById("btnExport");
  const btnExportPdf = document.getElementById("btnExportPdf");
  const inpImport = document.getElementById("inpImport");

  const cityList = document.getElementById("cityList");
  const cityFilterList = document.getElementById("cityFilterList");
  const cityFilterCount = document.getElementById("cityFilterCount");
  const btnSelectAll = document.getElementById("btnSelectAll");
  const btnSelectNone = document.getElementById("btnSelectNone");
  const btnAddCity = document.getElementById("btnAddCity");

  // Track selected cities (array of city IDs)
  let selectedCityIds = [];

  const viewAll = document.getElementById("viewAll");
  const viewCity = document.getElementById("viewCity");
  const viewTimeline = document.getElementById("viewTimeline");
  const viewTickets = document.getElementById("viewTickets");
  const viewCalendar = document.getElementById("viewCalendar");
  const viewMap = document.getElementById("viewMap");
  const viewToday = document.getElementById("viewToday");

  // Map and Calendar instances
  let leafletMap = null;
  let fullCalendar = null;

  // ---------- Tabs ----------
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      showTab(t.dataset.tab);
    });
  });

  function showTab(tab) {
    viewAll.style.display = tab === "all" ? "block" : "none";
    viewCity.style.display = tab === "city" ? "block" : "none";
    viewTimeline.style.display = tab === "timeline" ? "block" : "none";
    viewTickets.style.display = tab === "tickets" ? "block" : "none";
    viewCalendar.style.display = tab === "calendar" ? "block" : "none";
    viewMap.style.display = tab === "map" ? "block" : "none";
    viewToday.style.display = tab === "today" ? "block" : "none";

    if (tab === "timeline") renderTimeline();
    if (tab === "calendar") renderCalendar();
    if (tab === "map") renderMap();
    if (tab === "today") renderToday();
  }

  // ---------- Filter ----------
  function getSelectedCities() {
    // If no cities selected, return all
    if (selectedCityIds.length === 0) {
      return trip.cities.map(c => c.id);
    }
    return selectedCityIds;
  }

  function isCitySelected(cityId) {
    const selected = getSelectedCities();
    return selected.includes(cityId);
  }

  function rebuildCityFilter() {
    cityFilterList.innerHTML = "";

    // Clean up selectedCityIds - remove IDs that no longer exist
    selectedCityIds = selectedCityIds.filter(id => trip.cities.some(c => c.id === id));

    // If no selection, select all by default
    if (selectedCityIds.length === 0) {
      selectedCityIds = trip.cities.map(c => c.id);
    }

    for (const c of trip.cities) {
      const isSelected = selectedCityIds.includes(c.id);
      const item = document.createElement("label");
      item.className = `city-filter-item ${isSelected ? 'selected' : ''}`;
      item.innerHTML = `
        <input type="checkbox" data-city-id="${c.id}" ${isSelected ? 'checked' : ''} />
        <div class="city-info">
          <span class="dot" style="background:${c.color}; width:10px; height:10px;"></span>
          <span class="city-name">${escapeHtml(c.name)}</span>
          <span class="city-nights">${c.nights} noches</span>
        </div>
      `;

      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', (evt) => {
        if (evt.target.checked) {
          if (!selectedCityIds.includes(c.id)) {
            selectedCityIds.push(c.id);
          }
          item.classList.add('selected');
        } else {
          selectedCityIds = selectedCityIds.filter(id => id !== c.id);
          item.classList.remove('selected');
        }
        updateCityFilterCount();
        triggerFilterChange();
      });

      cityFilterList.appendChild(item);
    }

    updateCityFilterCount();
  }

  function updateCityFilterCount() {
    const total = trip.cities.length;
    const selected = selectedCityIds.length;
    if (selected === total || selected === 0) {
      cityFilterCount.textContent = `Mostrando todas las ciudades (${total})`;
    } else {
      cityFilterCount.textContent = `Mostrando ${selected} de ${total} ciudades`;
    }
  }

  function triggerFilterChange() {
    renderAll();
    renderCity();
    renderTickets();
    if (document.querySelector('.tab.active')?.dataset.tab === "timeline") renderTimeline();
  }

  btnSelectAll.addEventListener("click", () => {
    selectedCityIds = trip.cities.map(c => c.id);
    rebuildCityFilter();
    triggerFilterChange();
  });

  btnSelectNone.addEventListener("click", () => {
    selectedCityIds = [];
    rebuildCityFilter();
    triggerFilterChange();
  });

  // ---------- Trip meta ----------
  function renderTripMeta() {
    tripTitle.textContent = trip.name;
    const totalNights = trip.cities.reduce((s,c) => s + c.nights, 0);
    const endExclusive = addDays(trip.startDate, totalNights);
    tripDates.textContent = `${formatDateES(trip.startDate)} ‚Üí ${formatDateES(addDays(endExclusive, -1))}`;
    inpTripName.value = trip.name;
    inpStartDate.value = trip.startDate;
  }

  btnSaveTrip.addEventListener("click", () => {
    const prev = JSON.parse(JSON.stringify(trip));

    trip.name = inpTripName.value.trim() || trip.name;
    trip.startDate = inpStartDate.value || trip.startDate;

    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  });

  btnReset.addEventListener("click", () => {
    trip = defaultTrip();
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  });

  btnExport.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(trip, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${trip.name.replace(/\s+/g,'_')}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Save to trip-data.json for server deployment
  btnSaveFile.addEventListener("click", () => {
    saveTripToFile();
  });

  inpImport.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try {
      const obj = JSON.parse(text);
      trip = obj;
      // si el import trae ciudades sin days, regeneramos; si trae days, respetamos
      if (!trip.cities?.some(c => c.days?.length)) {
        const prev = null;
        regenerateDaysPreserve(trip, prev);
      }
      seedBasePlan(trip); // si vino vac√≠o, carga base
      saveTrip(trip);
      rebuildCityFilter();
      renderEverything();
    } catch {
      alert("JSON inv√°lido");
    }
    inpImport.value = "";
  });

  // ---------- Cities ----------
  function renderCities() {
    cityList.innerHTML = "";
    for (const c of trip.cities) {
      const item = document.createElement("div");
      item.className = "city-item";
      item.dataset.cityId = c.id;

      item.innerHTML = `
        <div class="row" style="gap:10px;">
          <div class="handle">‚ò∞</div>
          <span class="dot" style="background:${c.color}"></span>
          <div>
            <div class="name">${escapeHtml(c.name)}</div>
            <div class="small">${escapeHtml(c.hotel || "")} ¬∑ ${c.nights} noches</div>
          </div>
        </div>
        <div class="row">
          <button data-act="edit">Editar</button>
          <button class="danger" data-act="del">Borrar</button>
        </div>
      `;

      item.querySelector('[data-act="edit"]').addEventListener("click", () => editCity(c.id));
      item.querySelector('[data-act="del"]').addEventListener("click", () => deleteCity(c.id));
      cityList.appendChild(item);
    }

    Sortable.create(cityList, {
      handle: ".handle",
      animation: 150,
      onEnd: () => {
        const prev = JSON.parse(JSON.stringify(trip));
        const ids = Array.from(cityList.querySelectorAll(".city-item")).map(x => x.dataset.cityId);
        trip.cities = ids.map(id => trip.cities.find(c => c.id === id));

        regenerateDaysPreserve(trip, prev);
        saveTrip(trip);
        rebuildCityFilter();
        renderEverything();
      }
    });
  }

  btnAddCity.addEventListener("click", () => {
    const prev = JSON.parse(JSON.stringify(trip));
    const c = { id: uid(), name:"Nueva ciudad", color:"#7dd3fc", nights:2, hotel:"", days:[] };
    trip.cities.push(c);
    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
    editCity(c.id);
  });

  function editCity(cityId) {
    const prev = JSON.parse(JSON.stringify(trip));
    const c = trip.cities.find(x => x.id === cityId);
    if (!c) return;

    const name = prompt("Nombre ciudad:", c.name);
    if (name === null) return;
    c.name = name.trim() || c.name;

    const nightsStr = prompt("Noches:", String(c.nights));
    if (nightsStr === null) return;
    c.nights = Math.max(1, parseInt(nightsStr,10) || c.nights);

    const hotel = prompt("Hotel:", c.hotel || "");
    if (hotel !== null) c.hotel = hotel;

    const color = prompt("Color (hex), ej #4f7cff:", c.color);
    if (color !== null && /^#([0-9a-fA-F]{6})$/.test(color.trim())) c.color = color.trim();

    regenerateDaysPreserve(trip, prev);
    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  }

  function deleteCity(cityId) {
    const c = trip.cities.find(x => x.id === cityId);
    if (!c) return;
    if (!confirm(`Borrar ciudad "${c.name}"?`)) return;

    const prev = JSON.parse(JSON.stringify(trip));
    trip.cities = trip.cities.filter(x => x.id !== cityId);
    regenerateDaysPreserve(trip, prev);

    saveTrip(trip);
    rebuildCityFilter();
    renderEverything();
  }

  // ---------- UI State Preservation ----------
  // Store open states to preserve across re-renders
  let preservedOpenDays = new Set();
  let preservedEditingEvents = new Set();
  let preservedOpenCities = new Set();

  function saveUIState() {
    // Save open day details
    preservedOpenDays = new Set();
    document.querySelectorAll('details[data-day-id]').forEach(det => {
      if (det.open) preservedOpenDays.add(det.dataset.dayId);
    });

    // Save open city details (in City view)
    preservedOpenCities = new Set();
    document.querySelectorAll('details[data-city-id]').forEach(det => {
      if (det.open) preservedOpenCities.add(det.dataset.cityId);
    });

    // Save editing events
    preservedEditingEvents = new Set();
    document.querySelectorAll('.event.editing').forEach(el => {
      preservedEditingEvents.add(el.dataset.eventId);
    });
  }

  function restoreUIState() {
    // Restore open day details
    document.querySelectorAll('details[data-day-id]').forEach(det => {
      if (preservedOpenDays.has(det.dataset.dayId)) {
        det.open = true;
      }
    });

    // Restore open city details
    document.querySelectorAll('details[data-city-id]').forEach(det => {
      if (preservedOpenCities.has(det.dataset.cityId)) {
        det.open = true;
      }
    });

    // Restore editing events
    document.querySelectorAll('.event').forEach(el => {
      if (preservedEditingEvents.has(el.dataset.eventId)) {
        el.classList.add('editing');
      }
    });
  }

  // ---------- Views ----------
  function dayDetails(city, day, openByDefault) {
    const det = document.createElement("details");
    det.dataset.dayId = day.id; // Track by day ID for state preservation
    det.open = !!openByDefault; // para que veas eventos sin tener que abrir todo
    det.innerHTML = `
      <summary>
        <span>${formatDateES(day.date)}</span>
        <span class="small">${escapeHtml(city.name)}</span>
      </summary>
    `;

    const box = document.createElement("div");
    box.style.marginTop = "10px";

    const btnRow = document.createElement("div");
    btnRow.className = "row";
    btnRow.innerHTML = `
      <button class="primary">+ Evento</button>
      <span class="small">Arrastr√° para reordenar o mover entre d√≠as.</span>
      <span class="pill small">${escapeHtml(city.hotel || "")}</span>
    `;
    btnRow.querySelector("button").addEventListener("click", () => {
      day.events.push(ev("Nuevo evento", "paseo", "", "", "", false));
      saveTrip(trip);
      renderEverything();
    });

    const events = document.createElement("div");
    events.className = "events";
    events.dataset.cityId = city.id;
    events.dataset.dayId = day.id;

    for (const e of day.events) {
      events.appendChild(eventCard(city, day, e));
    }

    box.appendChild(btnRow);
    box.appendChild(events);
    det.appendChild(box);

    wireDnD(events);
    return det;
  }

  // Lista de tipos de evento para el selector
  const EVENT_TYPES = [
    'paseo', 'museo', 'ticket', 'comida', 'arquitectura', 'barrio',
    'cultura', 'arte', 'dise√±o', 'm√∫sica', 'log√≠stica', 'hotel',
    'transporte', 'compras', 'naturaleza', 'playa', 'nocturno',
    'foto', 'mirador', 'religioso', 'mercado', 'caf√©', 'bar', 'show', 'tour'
  ];

  function eventCard(city, day, e) {
    const el = document.createElement("div");
    el.className = "event";
    el.dataset.eventId = e.id;
    el.dataset.cityId = city.id;
    el.dataset.dayId = day.id;

    const icon = getEventIcon(e.type);
    const timePart = e.startTime ? `${escapeHtml(e.startTime)}${e.endTime ? " ‚Äì "+escapeHtml(e.endTime) : ""}` : "";
    const linkPart = e.link ? `<a href="${escapeHtml(e.link)}" target="_blank" onclick="event.stopPropagation()">üîó</a>` : "";

    // Generar opciones del select de tipos
    const typeOptions = EVENT_TYPES.map(t =>
      `<option value="${t}" ${e.type === t ? 'selected' : ''}>${t}</option>`
    ).join('');

    el.innerHTML = `
      <div class="event-view">
        <div class="left" style="display:flex; align-items:flex-start; gap:8px;">
          <span class="event-handle" title="Arrastrar">‚ò∞</span>
          <div>
            <div class="title"><span class="icon">${icon}</span> ${escapeHtml(e.title)}</div>
            ${e.notes ? `<div class="event-notes-inline">${escapeHtml(e.notes)}</div>` : ''}
            <div class="meta">
              <span class="type-badge">${escapeHtml(e.type || "evento")}</span>
              ${timePart ? `<span class="time">üïê ${timePart}</span>` : ""}
              ${linkPart}
            </div>
          </div>
        </div>
        <div class="quick-actions">
          ${e.ticketRequired ? `
            <label class="ticket-checkbox ${e.ticketBought ? 'bought' : 'pending'}" title="Click para cambiar estado">
              <input type="checkbox" data-act="ticket" ${e.ticketBought ? 'checked' : ''} />
              <span>${e.ticketBought ? '‚úì Comprado' : '‚ö† Pendiente'}</span>
            </label>
          ` : ''}
          <button class="btn-icon" data-act="edit" title="Editar">‚úèÔ∏è</button>
          <button class="btn-icon danger" data-act="del" title="Borrar">üóëÔ∏è</button>
        </div>
      </div>

      <div class="event-edit-form">
        <div class="edit-grid">
          <div class="edit-field full-width">
            <label>T√≠tulo</label>
            <input type="text" data-field="title" value="${escapeHtml(e.title)}" />
          </div>
          <div class="edit-field">
            <label>Tipo</label>
            <select data-field="type">
              <option value="">-- Seleccionar --</option>
              ${typeOptions}
            </select>
          </div>
          <div class="edit-field">
            <label>Link</label>
            <input type="url" data-field="link" value="${escapeHtml(e.link || '')}" placeholder="https://..." />
          </div>
          <div class="edit-field">
            <label>Hora inicio</label>
            <input type="text" data-field="startTime" value="${escapeHtml(e.startTime || '')}" placeholder="10:00 o 'tarde'" />
          </div>
          <div class="edit-field">
            <label>Hora fin</label>
            <input type="text" data-field="endTime" value="${escapeHtml(e.endTime || '')}" placeholder="14:00 (opcional)" />
          </div>
          <div class="edit-field full-width">
            <label>Notas</label>
            <textarea data-field="notes" rows="2" placeholder="Detalles adicionales...">${escapeHtml(e.notes || '')}</textarea>
          </div>
          <div class="edit-field">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" data-field="ticketRequired" ${e.ticketRequired ? 'checked' : ''} style="width:16px;height:16px;" />
              Requiere ticket/entrada
            </label>
          </div>
          <div class="edit-field">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" data-field="ticketBought" ${e.ticketBought ? 'checked' : ''} ${!e.ticketRequired ? 'disabled' : ''} style="width:16px;height:16px;" />
              Ticket comprado
            </label>
          </div>
        </div>
        <div class="edit-actions">
          <button class="primary" data-act="save">üíæ Guardar</button>
          <button data-act="cancel">Cancelar</button>
        </div>
      </div>
    `;

    // Event: Toggle ticket bought (quick action)
    const ticketCheckbox = el.querySelector('[data-act="ticket"]');
    if (ticketCheckbox) {
      ticketCheckbox.addEventListener("change", (evt) => {
        evt.stopPropagation();
        e.ticketBought = evt.target.checked;
        saveTrip(trip);
        // Update label
        const label = evt.target.closest('.ticket-checkbox');
        label.className = `ticket-checkbox ${e.ticketBought ? 'bought' : 'pending'}`;
        label.querySelector('span').textContent = e.ticketBought ? '‚úì Comprado' : '‚ö† Pendiente';
      });
    }

    // Event: Edit button - toggle edit mode
    el.querySelector('[data-act="edit"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      el.classList.toggle('editing');
    });

    // Event: Cancel editing
    el.querySelector('[data-act="cancel"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      el.classList.remove('editing');
      // Reset form values
      el.querySelector('[data-field="title"]').value = e.title;
      el.querySelector('[data-field="type"]').value = e.type || '';
      el.querySelector('[data-field="link"]').value = e.link || '';
      el.querySelector('[data-field="startTime"]').value = e.startTime || '';
      el.querySelector('[data-field="endTime"]').value = e.endTime || '';
      el.querySelector('[data-field="notes"]').value = e.notes || '';
      el.querySelector('[data-field="ticketRequired"]').checked = e.ticketRequired;
      el.querySelector('[data-field="ticketBought"]').checked = e.ticketBought;
    });

    // Event: Save changes
    el.querySelector('[data-act="save"]').addEventListener("click", (evt) => {
      evt.stopPropagation();

      const newTitle = el.querySelector('[data-field="title"]').value.trim();
      e.title = newTitle || e.title;
      e.type = el.querySelector('[data-field="type"]').value;
      e.link = el.querySelector('[data-field="link"]').value.trim();
      e.startTime = el.querySelector('[data-field="startTime"]').value.trim();
      e.endTime = el.querySelector('[data-field="endTime"]').value.trim();
      e.notes = el.querySelector('[data-field="notes"]').value.trim();
      e.ticketRequired = el.querySelector('[data-field="ticketRequired"]').checked;
      e.ticketBought = el.querySelector('[data-field="ticketBought"]').checked;

      if (!e.ticketRequired) e.ticketBought = false;

      // Close the edit form
      el.classList.remove('editing');

      // Show save confirmation
      el.classList.add('just-saved');
      setTimeout(() => el.classList.remove('just-saved'), 1500);

      saveTrip(trip);
      renderEverything(false);
    });

    // Event: ticketRequired checkbox controls ticketBought
    el.querySelector('[data-field="ticketRequired"]').addEventListener("change", (evt) => {
      const ticketBoughtCheckbox = el.querySelector('[data-field="ticketBought"]');
      ticketBoughtCheckbox.disabled = !evt.target.checked;
      if (!evt.target.checked) ticketBoughtCheckbox.checked = false;
    });

    // Event: Delete
    el.querySelector('[data-act="del"]').addEventListener("click", (evt) => {
      evt.stopPropagation();
      if (!confirm(`¬øBorrar "${e.title}"?`)) return;
      for (const c of trip.cities) {
        for (const d of c.days) {
          const idx = d.events.findIndex(x => x.id === e.id);
          if (idx >= 0) {
            d.events.splice(idx, 1);
            saveTrip(trip);
            renderEverything();
            return;
          }
        }
      }
    });

    return el;
  }

  function renderAll() {
    viewAll.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Todo el viaje</div>`;
    viewAll.appendChild(card);

    const daysWrap = document.createElement("div");
    daysWrap.className = "days";
    card.appendChild(daysWrap);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;

      const head = document.createElement("div");
      head.className = "city-pill";
      head.innerHTML = `<span class="dot" style="background:${c.color}"></span>
                        <div><b>${escapeHtml(c.name)}</b> <span class="small">¬∑ ${c.nights} noches ¬∑ ${escapeHtml(c.hotel||"")}</span></div>`;
      daysWrap.appendChild(head);

      c.days.forEach((d, idx) => {
        // Abrimos por default el primer d√≠a de cada ciudad para que veas eventos al toque
        daysWrap.appendChild(dayDetails(c, d, idx === 0));
      });
    }
  }

  function renderCity() {
    viewCity.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Vista por ciudad</div>`;
    viewCity.appendChild(card);

    const list = document.createElement("div");
    list.className = "days";
    card.appendChild(list);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;

      const det = document.createElement("details");
      det.dataset.cityId = c.id; // Track by city ID for state preservation
      det.open = true;
      det.innerHTML = `
        <summary>
          <span class="row" style="gap:10px;">
            <span class="dot" style="background:${c.color}"></span>
            <span>${escapeHtml(c.name)}</span>
            <span class="small">${escapeHtml(c.hotel||"")} ¬∑ ${c.nights} noches</span>
          </span>
          <span class="small">click para colapsar</span>
        </summary>
      `;
      const inner = document.createElement("div");
      inner.className = "days";
      inner.style.marginTop = "10px";
      det.appendChild(inner);

      c.days.forEach((d, idx) => inner.appendChild(dayDetails(c, d, idx === 0)));
      list.appendChild(det);
    }
  }

  function renderTickets() {
    viewTickets.innerHTML = "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Tickets</div>
                      <div class="small">Marc√° comprado. Links en cada evento.</div>`;
    viewTickets.appendChild(card);

    const wrap = document.createElement("div");
    wrap.className = "days";
    card.appendChild(wrap);

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;
      for (const d of c.days) {
        for (const e of d.events) {
          if (!e.ticketRequired) continue;

          const t = document.createElement("div");
          t.className = "ticket";
          t.innerHTML = `
            <input type="checkbox" ${e.ticketBought ? "checked" : ""} />
            <div style="flex:1;">
              <div class="tname">${escapeHtml(e.title)}</div>
              <div class="small">${escapeHtml(c.name)} ¬∑ ${formatDateES(d.date)} ¬∑ ${escapeHtml(e.startTime||"")}</div>
              ${e.link ? `<div class="small"><a href="${escapeHtml(e.link)}" target="_blank">Link</a></div>` : ""}
            </div>
          `;
          t.querySelector("input").addEventListener("change", (ev) => {
            e.ticketBought = ev.target.checked;
            saveTrip(trip);
          });
          wrap.appendChild(t);
        }
      }
    }

    if (!wrap.children.length) {
      const empty = document.createElement("div");
      empty.className = "small";
      empty.textContent = "No hay tickets marcados como requeridos todav√≠a.";
      wrap.appendChild(empty);
    }
  }

  // ---------- Drag & drop ----------
  function wireDnD(container) {
    Sortable.create(container, {
      group: "events",
      handle: ".event-handle",
      animation: 150,
      ghostClass: "sortable-ghost",
      chosenClass: "sortable-chosen",
      onEnd: (evt) => {
        const fromCityId = evt.from.dataset.cityId;
        const fromDayId  = evt.from.dataset.dayId;
        const toCityId   = evt.to.dataset.cityId;
        const toDayId    = evt.to.dataset.dayId;
        const eventId    = evt.item.dataset.eventId;

        const fromCity = trip.cities.find(c => c.id === fromCityId);
        const toCity   = trip.cities.find(c => c.id === toCityId);
        const fromDay  = fromCity.days.find(d => d.id === fromDayId);
        const toDay    = toCity.days.find(d => d.id === toDayId);

        const moved = fromDay.events.find(e => e.id === eventId);
        fromDay.events = fromDay.events.filter(e => e.id !== eventId);

        const newIndex = evt.newIndex;
        toDay.events.splice(newIndex, 0, moved);

        saveTrip(trip);
        renderEverything(false);
      }
    });
  }

  // Wire drag & drop for timeline events
  function wireTimelineDnD() {
    document.querySelectorAll('.timeline-events[data-day-id]').forEach(container => {
      Sortable.create(container, {
        group: "timeline-events",
        handle: ".event-handle",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        onEnd: (evt) => {
          const fromDayId = evt.from.dataset.dayId;
          const toDayId = evt.to.dataset.dayId;
          const eventId = evt.item.dataset.eventId;

          // Find the days
          let fromDay = null, toDay = null;
          for (const c of trip.cities) {
            for (const d of c.days) {
              if (d.id === fromDayId) fromDay = d;
              if (d.id === toDayId) toDay = d;
            }
          }

          if (!fromDay || !toDay) return;

          const moved = fromDay.events.find(e => e.id === eventId);
          if (!moved) return;

          fromDay.events = fromDay.events.filter(e => e.id !== eventId);
          toDay.events.splice(evt.newIndex, 0, moved);

          saveTrip(trip);
          renderEverything(); // Re-render all views to keep in sync
        }
      });
    });
  }

  // ---------- Timeline Continua ----------
  // Determinar tipo de d√≠a (llegada, partida, completo)
  function getDayType(city, dayIndex) {
    const isFirstDay = dayIndex === 0;
    const isLastDay = dayIndex === city.days.length - 1;

    // Si tiene firstDayType o lastDayType definido en la ciudad, usarlo
    if (isFirstDay && city.firstDayType) return city.firstDayType;
    if (isLastDay && city.lastDayType) return city.lastDayType;

    // Default: primer d√≠a es llegada, √∫ltimo es partida
    if (isFirstDay) return 'arrival';
    if (isLastDay) return 'departure';
    return 'full';
  }

  function getDayTypeBadge(dayType) {
    switch(dayType) {
      case 'arrival': return '<span class="day-type-badge arrival">üõ¨ Llegada</span>';
      case 'departure': return '<span class="day-type-badge departure">üõ´ Partida</span>';
      case 'full': return '<span class="day-type-badge full">üìÖ D√≠a completo</span>';
      default: return '';
    }
  }

  function renderTimeline() {
    const container = document.getElementById("timelineContent");
    if (!container) return;

    // Recopilar todos los d√≠as con su ciudad
    const allDays = [];
    const dateToNumber = new Map(); // Mapea fecha -> n√∫mero de d√≠a
    let uniqueDayCount = 0;

    for (const c of trip.cities) {
      if (!isCitySelected(c.id)) continue;
      for (let i = 0; i < c.days.length; i++) {
        const d = c.days[i];
        const dayType = getDayType(c, i);

        // Asignar n√∫mero de d√≠a basado en la fecha √∫nica
        if (!dateToNumber.has(d.date)) {
          uniqueDayCount++;
          dateToNumber.set(d.date, uniqueDayCount);
        }
        const dayNum = dateToNumber.get(d.date);

        allDays.push({ city: c, day: d, dayNum, dayIndex: i, dayType });
      }
    }

    // Calcular estad√≠sticas - usar d√≠as √∫nicos, no total de entries
    const totalDays = uniqueDayCount;
    const totalEvents = allDays.reduce((sum, item) => sum + (item.day.events?.length || 0), 0);
    const ticketsPending = allDays.reduce((sum, item) =>
      sum + (item.day.events?.filter(e => e.ticketRequired && !e.ticketBought).length || 0), 0);
    const citiesCount = getSelectedCities().length;

    // Construir HTML
    let html = `
      <div class="timeline-container">
        <div class="timeline-header">
          <h2>üóìÔ∏è Timeline del viaje</h2>
          <div class="timeline-stats">
            <div class="timeline-stat">
              <div class="value">${totalDays}</div>
              <div class="label">D√≠as</div>
            </div>
            <div class="timeline-stat">
              <div class="value">${citiesCount}</div>
              <div class="label">Ciudades</div>
            </div>
            <div class="timeline-stat">
              <div class="value">${totalEvents}</div>
              <div class="label">Eventos</div>
            </div>
            ${ticketsPending > 0 ? `
            <div class="timeline-stat">
              <div class="value" style="color: var(--warning)">${ticketsPending}</div>
              <div class="label">Tickets pendientes</div>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="timeline-legend">
          <div class="timeline-legend-item"><span class="icon">üèõÔ∏è</span> Museo</div>
          <div class="timeline-legend-item"><span class="icon">üö∂</span> Paseo</div>
          <div class="timeline-legend-item"><span class="icon">üéüÔ∏è</span> Ticket</div>
          <div class="timeline-legend-item"><span class="icon">üçΩÔ∏è</span> Comida</div>
          <div class="timeline-legend-item"><span class="icon">üé≠</span> Cultura</div>
          <div class="timeline-legend-item"><span class="icon">üé®</span> Arte</div>
          <div class="timeline-legend-item"><span class="icon">üèóÔ∏è</span> Arquitectura</div>
          <div class="timeline-legend-item"><span class="icon">üèòÔ∏è</span> Barrio</div>
          <div class="timeline-legend-item"><span class="icon">‚úàÔ∏è</span> Log√≠stica</div>
        </div>

        <div class="small" style="margin-bottom:16px; padding:10px; background:var(--panel); border-radius:8px; border:1px solid var(--line);">
          üí° <b>Tip:</b> Arrastr√° eventos con el √≠cono ‚ò∞ para reordenarlos o moverlos entre d√≠as.
          Los d√≠as de llegada/partida indican transiciones entre ciudades.
        </div>

        <div class="timeline-scroll">
          <div class="timeline-line"></div>
    `;

    if (allDays.length === 0) {
      html += `
        <div class="timeline-empty">
          <div class="icon">üó∫Ô∏è</div>
          <div>No hay d√≠as para mostrar</div>
          <div class="small">Agreg√° ciudades y eventos para ver tu timeline</div>
        </div>
      `;
    } else {
      let lastCityId = null;

      for (const { city, day, dayNum, dayIndex, dayType } of allDays) {
        // Si cambi√≥ la ciudad, mostrar transici√≥n
        if (lastCityId !== null && lastCityId !== city.id) {
          html += `
            <div class="timeline-city-change">
              <div class="timeline-city-change-marker" style="background: ${city.color}; border-color: ${city.color}; color: white;">
                üöÄ
              </div>
              <div class="timeline-city-change-content">
                <span class="city-name">
                  <span class="dot" style="background: ${city.color}; box-shadow: 0 0 8px ${city.color}"></span>
                  Llegada a ${escapeHtml(city.name)}
                </span>
                <span class="arrow">‚Üí</span>
                <span class="small">${city.nights} noches</span>
              </div>
            </div>
          `;
        }
        lastCityId = city.id;

        // D√≠a - apply city color as background
        html += `
          <div class="timeline-day" style="background: ${city.color}; color: #fff;">
            <div class="timeline-day-marker" style="color: ${city.color};">${dayNum}</div>
            <div class="timeline-day-header">
              <span class="date">${formatDateES(day.date)}</span>
              <span class="city-tag">
                <span class="dot"></span>
                ${escapeHtml(city.name)}
              </span>
              ${getDayTypeBadge(dayType)}
              ${city.hotel ? `<span class="hotel">üè® ${escapeHtml(city.hotel)}</span>` : ''}
            </div>
            <div class="timeline-events" data-day-id="${day.id}" data-city-id="${city.id}">
        `;

        if (!day.events || day.events.length === 0) {
          html += `
            <div class="timeline-event timeline-event-empty">
              <div class="icon">üìù</div>
              <div class="content">
                <div class="event-title" style="color: #666">Sin eventos planificados</div>
                <div class="event-meta">${dayType === 'arrival' ? 'D√≠a de llegada - tarde libre' : dayType === 'departure' ? 'D√≠a de partida - ma√±ana libre' : 'D√≠a libre o por planificar'}</div>
              </div>
            </div>
          `;
        } else {
          for (const e of day.events) {
            const icon = getEventIcon(e.type);
            const timePart = e.startTime ? `${escapeHtml(e.startTime)}${e.endTime ? ' ‚Äì ' + escapeHtml(e.endTime) : ''}` : '';

            let ticketBadge = '';
            if (e.ticketRequired) {
              ticketBadge = e.ticketBought
                ? `<span class="ticket-badge bought">‚úì Comprado</span>`
                : `<span class="ticket-badge pending">‚ö† Pendiente</span>`;
            }

            html += `
              <div class="timeline-event" data-event-id="${e.id}" data-day-id="${day.id}" data-city-id="${city.id}">
                <span class="event-handle" title="Arrastrar">‚ò∞</span>
                <div class="icon">${icon}</div>
                <div class="content">
                  <div class="event-title">${escapeHtml(e.title)}</div>
                  ${e.notes ? `<div class="event-notes">${escapeHtml(e.notes)}</div>` : ''}
                  <div class="event-meta">
                    ${timePart ? `<span class="event-time">üïê ${timePart}</span>` : ''}
                    <span class="event-type">${escapeHtml(e.type || 'evento')}</span>
                    ${ticketBadge}
                  </div>
                </div>
                <div class="timeline-event-actions">
                  ${e.link ? `<a href="${escapeHtml(e.link)}" target="_blank" class="event-link" title="Abrir link">üîó</a>` : ''}
                  <button class="btn-icon timeline-edit-btn" data-event-id="${e.id}" data-day-id="${day.id}" data-city-id="${city.id}" title="Editar">‚úèÔ∏è</button>
                  <button class="btn-icon timeline-delete-btn" data-event-id="${e.id}" data-day-id="${day.id}" data-city-id="${city.id}" title="Eliminar">üóëÔ∏è</button>
                </div>
              </div>
            `;
          }
        }

        // Add event button for this day
        html += `
            <button class="timeline-add-event-btn" data-day-id="${day.id}" data-city-id="${city.id}">+ Agregar evento</button>
            </div>
          </div>
        `;
      }
    }

    html += `
        </div>
      </div>
    `;

    container.innerHTML = html;

    // Wire drag & drop after rendering
    wireTimelineDnD();

    // Wire delete buttons
    container.querySelectorAll('.timeline-delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const eventId = btn.dataset.eventId;
        const dayId = btn.dataset.dayId;
        const cityId = btn.dataset.cityId;

        if (!confirm('¬øEliminar este evento?')) return;

        const city = trip.cities.find(c => c.id === cityId);
        if (!city) return;
        const day = city.days.find(d => d.id === dayId);
        if (!day) return;

        day.events = day.events.filter(ev => ev.id !== eventId);
        saveTrip(trip);
        renderEverything();
      });
    });

    // Wire edit buttons
    container.querySelectorAll('.timeline-edit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const eventId = btn.dataset.eventId;
        const dayId = btn.dataset.dayId;
        const cityId = btn.dataset.cityId;

        openTimelineEditModal(cityId, dayId, eventId);
      });
    });

    // Wire add event buttons
    container.querySelectorAll('.timeline-add-event-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const dayId = btn.dataset.dayId;
        const cityId = btn.dataset.cityId;
        openTimelineEditModal(cityId, dayId, null); // null = new event
      });
    });
  }

  // Timeline edit modal
  function openTimelineEditModal(cityId, dayId, eventId) {
    const city = trip.cities.find(c => c.id === cityId);
    if (!city) return;
    const day = city.days.find(d => d.id === dayId);
    if (!day) return;

    const event = eventId ? day.events.find(e => e.id === eventId) : null;
    const isNew = !event;

    // Create modal
    const modal = document.createElement('div');
    modal.className = 'timeline-modal-overlay';
    modal.innerHTML = `
      <div class="timeline-modal">
        <h3>${isNew ? 'Nuevo Evento' : 'Editar Evento'}</h3>
        <div class="edit-grid">
          <div class="edit-field full-width">
            <label>T√≠tulo</label>
            <input type="text" id="modalEventTitle" value="${escapeHtml(event?.title || '')}" placeholder="Nombre del evento">
          </div>
          <div class="edit-field">
            <label>Tipo</label>
            <select id="modalEventType">
              <option value="museo" ${event?.type === 'museo' ? 'selected' : ''}>üèõÔ∏è Museo</option>
              <option value="restaurant" ${event?.type === 'restaurant' ? 'selected' : ''}>üçΩÔ∏è Restaurant</option>
              <option value="tour" ${event?.type === 'tour' ? 'selected' : ''}>üö∂ Tour</option>
              <option value="transporte" ${event?.type === 'transporte' ? 'selected' : ''}>üöå Transporte</option>
              <option value="vuelo" ${event?.type === 'vuelo' ? 'selected' : ''}>‚úàÔ∏è Vuelo</option>
              <option value="show" ${event?.type === 'show' ? 'selected' : ''}>üé≠ Show</option>
              <option value="compras" ${event?.type === 'compras' ? 'selected' : ''}>üõçÔ∏è Compras</option>
              <option value="naturaleza" ${event?.type === 'naturaleza' ? 'selected' : ''}>üå≥ Naturaleza</option>
              <option value="playa" ${event?.type === 'playa' ? 'selected' : ''}>üèñÔ∏è Playa</option>
              <option value="evento" ${(!event?.type || event?.type === 'evento') ? 'selected' : ''}>üìå Evento</option>
            </select>
          </div>
          <div class="edit-field">
            <label>Hora inicio</label>
            <input type="time" id="modalEventStart" value="${event?.startTime || ''}">
          </div>
          <div class="edit-field">
            <label>Hora fin</label>
            <input type="time" id="modalEventEnd" value="${event?.endTime || ''}">
          </div>
          <div class="edit-field">
            <label>Link</label>
            <input type="url" id="modalEventLink" value="${escapeHtml(event?.link || '')}" placeholder="https://...">
          </div>
          <div class="edit-field full-width">
            <label>Notas</label>
            <textarea id="modalEventNotes" rows="2" placeholder="Detalles adicionales...">${escapeHtml(event?.notes || '')}</textarea>
          </div>
          <div class="edit-field">
            <label class="ticket-checkbox ${event?.ticketRequired ? (event?.ticketBought ? 'bought' : 'pending') : ''}">
              <input type="checkbox" id="modalEventTicket" ${event?.ticketRequired ? 'checked' : ''}>
              <span>Requiere ticket</span>
            </label>
          </div>
          <div class="edit-field">
            <label class="ticket-checkbox ${event?.ticketBought ? 'bought' : ''}">
              <input type="checkbox" id="modalEventBought" ${event?.ticketBought ? 'checked' : ''}>
              <span>Ticket comprado</span>
            </label>
          </div>
          <div class="edit-field full-width" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--line);">
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              üìç Ubicaci√≥n en mapa <span style="font-size:11px; color:var(--muted);">(opcional - para ver en mapa de ciudad)</span>
            </label>
            <div style="display:flex; gap:8px;">
              <input type="number" step="any" id="modalEventLat" value="${event?.lat || ''}" placeholder="Latitud (ej: 40.4168)" style="flex:1;">
              <input type="number" step="any" id="modalEventLng" value="${event?.lng || ''}" placeholder="Longitud (ej: -3.7038)" style="flex:1;">
            </div>
          </div>
        </div>
        <div class="edit-actions">
          <button class="primary" id="modalSaveBtn">üíæ Guardar</button>
          <button id="modalCancelBtn">Cancelar</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Focus title
    document.getElementById('modalEventTitle').focus();

    // Wire modal buttons
    document.getElementById('modalCancelBtn').addEventListener('click', () => {
      modal.remove();
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });

    document.getElementById('modalSaveBtn').addEventListener('click', () => {
      const title = document.getElementById('modalEventTitle').value.trim();
      if (!title) {
        alert('El t√≠tulo es requerido');
        return;
      }

      const latVal = document.getElementById('modalEventLat').value;
      const lngVal = document.getElementById('modalEventLng').value;

      const eventData = {
        id: event?.id || uid(),
        title: title,
        type: document.getElementById('modalEventType').value,
        startTime: document.getElementById('modalEventStart').value,
        endTime: document.getElementById('modalEventEnd').value,
        link: document.getElementById('modalEventLink').value,
        notes: document.getElementById('modalEventNotes').value,
        ticketRequired: document.getElementById('modalEventTicket').checked,
        ticketBought: document.getElementById('modalEventBought').checked,
        lat: latVal ? parseFloat(latVal) : null,
        lng: lngVal ? parseFloat(lngVal) : null
      };

      if (isNew) {
        day.events.push(eventData);
      } else {
        const idx = day.events.findIndex(e => e.id === eventId);
        if (idx >= 0) day.events[idx] = eventData;
      }

      saveTrip(trip);
      modal.remove();
      renderEverything();
    });
  }

  // ---------- PDF export ----------
  btnExportPdf.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const margin = 40;
    let y = margin;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(trip.name || "Viaje", margin, y);
    y += 18;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const totalNights = trip.cities.reduce((s,c)=>s+c.nights,0);
    const endExclusive = addDays(trip.startDate, totalNights);
    doc.text(`${formatDateES(trip.startDate)} ‚Üí ${formatDateES(addDays(endExclusive, -1))}`, margin, y);
    y += 18;

    // Itinerario tabla
    const rows = [];
    for (const c of trip.cities) {
      for (const d of c.days) {
        const evs = (d.events||[])
          .map(e => {
            const t = e.startTime ? `${e.startTime}${e.endTime ? "‚Äì"+e.endTime : ""}` : "";
            const ticket = e.ticketRequired ? (e.ticketBought ? " (Ticket comprado)" : " (Ticket pendiente)") : "";
            return `‚Ä¢ ${t ? t+" " : ""}${e.title}${ticket}`;
          })
          .join("\n");
        rows.push([
          c.name,
          d.date,
          d.date ? formatDateES(d.date) : "",
          c.hotel || "",
          evs || ""
        ]);
      }
    }

    doc.autoTable({
      startY: y,
      head: [["Ciudad", "Fecha", "D√≠a", "Hotel", "Eventos"]],
      body: rows,
      styles: { fontSize: 8, cellPadding: 4, overflow: "linebreak" },
      headStyles: { fillColor: [27, 32, 48] },
      columnStyles: {
        0: { cellWidth: 80 },
        1: { cellWidth: 55 },
        2: { cellWidth: 90 },
        3: { cellWidth: 120 },
        4: { cellWidth: 170 }
      },
      margin: { left: margin, right: margin }
    });

    // Tickets tabla
    const tickets = [];
    for (const c of trip.cities) {
      for (const d of c.days) {
        for (const e of d.events) {
          if (!e.ticketRequired) continue;
          tickets.push([
            c.name,
            formatDateES(d.date),
            e.title,
            e.ticketBought ? "Comprado" : "Pendiente",
            e.link || ""
          ]);
        }
      }
    }

    doc.addPage();
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Tickets", margin, margin);

    doc.autoTable({
      startY: margin + 12,
      head: [["Ciudad", "Fecha", "Lugar/Evento", "Estado", "Link"]],
      body: tickets.length ? tickets : [["-", "-", "No hay tickets marcados", "-", "-"]],
      styles: { fontSize: 8, cellPadding: 4, overflow: "linebreak" },
      headStyles: { fillColor: [27, 32, 48] },
      columnStyles: { 0:{cellWidth:80}, 1:{cellWidth:90}, 2:{cellWidth:180}, 3:{cellWidth:70}, 4:{cellWidth:120} },
      margin: { left: margin, right: margin }
    });

    doc.save(`${(trip.name||"viaje").replace(/\s+/g,"_")}.pdf`);
  });

  // ---------- City Coordinates Helper ----------
  // Known city coordinates for common destinations
  const CITY_COORDS = {
    'madrid': { lat: 40.4168, lng: -3.7038 },
    'valencia': { lat: 39.4699, lng: -0.3763 },
    'barcelona': { lat: 41.3851, lng: 2.1734 },
    'roma': { lat: 41.9028, lng: 12.4964 },
    'rome': { lat: 41.9028, lng: 12.4964 },
    'florencia': { lat: 43.7696, lng: 11.2558 },
    'florence': { lat: 43.7696, lng: 11.2558 },
    'venecia': { lat: 45.4408, lng: 12.3155 },
    'venice': { lat: 45.4408, lng: 12.3155 },
    'paris': { lat: 48.8566, lng: 2.3522 },
    'london': { lat: 51.5074, lng: -0.1278 },
    'amsterdam': { lat: 52.3676, lng: 4.9041 },
    'berlin': { lat: 52.5200, lng: 13.4050 },
    'viena': { lat: 48.2082, lng: 16.3738 },
    'vienna': { lat: 48.2082, lng: 16.3738 },
    'praga': { lat: 50.0755, lng: 14.4378 },
    'prague': { lat: 50.0755, lng: 14.4378 },
    'lisboa': { lat: 38.7223, lng: -9.1393 },
    'lisbon': { lat: 38.7223, lng: -9.1393 },
    'sevilla': { lat: 37.3891, lng: -5.9845 },
    'milan': { lat: 45.4642, lng: 9.1900 },
    'mil√°n': { lat: 45.4642, lng: 9.1900 },
    'napoles': { lat: 40.8518, lng: 14.2681 },
    'naples': { lat: 40.8518, lng: 14.2681 },
  };

  function getCityCoords(city) {
    // If city has coordinates, use them
    if (city.coords && city.coords.lat && city.coords.lng) {
      return city.coords;
    }
    // Try to find by name
    const baseName = city.name.toLowerCase().replace(/\s*\([^)]*\)/g, '').trim();
    return CITY_COORDS[baseName] || null;
  }

  // ---------- Weather API ----------
  async function fetchWeather(lat, lng) {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=7`;
      const response = await fetch(url);
      if (!response.ok) return null;
      return await response.json();
    } catch {
      return null;
    }
  }

  function getWeatherIcon(code) {
    // WMO Weather interpretation codes
    if (code === 0) return '‚òÄÔ∏è';
    if (code <= 3) return '‚õÖ';
    if (code <= 49) return 'üå´Ô∏è';
    if (code <= 59) return 'üåßÔ∏è';
    if (code <= 69) return '‚ùÑÔ∏è';
    if (code <= 79) return 'üå®Ô∏è';
    if (code <= 82) return 'üåßÔ∏è';
    if (code <= 86) return '‚ùÑÔ∏è';
    if (code >= 95) return '‚õàÔ∏è';
    return 'üå§Ô∏è';
  }

  function getWeatherDesc(code) {
    if (code === 0) return 'Despejado';
    if (code <= 3) return 'Parcialmente nublado';
    if (code <= 49) return 'Niebla';
    if (code <= 59) return 'Llovizna';
    if (code <= 69) return 'Lluvia';
    if (code <= 79) return 'Nieve';
    if (code <= 82) return 'Lluvia fuerte';
    if (code <= 86) return 'Nieve fuerte';
    if (code >= 95) return 'Tormenta';
    return 'Variable';
  }

  // ---------- Geocoding (Nominatim) ----------
  const GEOCODE_CACHE_KEY = 'trip_planner_geocache';
  let geocodeCache = {};
  let geocodeQueue = [];
  let isGeocoding = false;

  // Load cache from localStorage
  try {
    const cached = localStorage.getItem(GEOCODE_CACHE_KEY);
    if (cached) geocodeCache = JSON.parse(cached);
  } catch {}

  function saveGeocodeCache() {
    try {
      localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(geocodeCache));
    } catch {}
  }

  function getCacheKey(placeName, cityName) {
    return `${placeName.toLowerCase().trim()}|${cityName.toLowerCase().trim()}`;
  }

  async function geocodePlace(placeName, cityName) {
    const cacheKey = getCacheKey(placeName, cityName);

    // Check cache first (including null = not found)
    if (cacheKey in geocodeCache) {
      return geocodeCache[cacheKey];
    }

    // Clean up place name for better search results
    let cleanName = placeName
      .replace(/\([^)]*\)/g, '')  // Remove parenthetical content
      .replace(/\s*[-‚Äì‚Äî]\s*.*/g, '')  // Remove everything after dash
      .replace(/[""‚Äû"¬´¬ª]/g, '')  // Remove fancy quotes
      .trim();

    // If name is too short after cleanup, use original
    if (cleanName.length < 3) {
      cleanName = placeName.split(/[-‚Äì‚Äî(]/)[0].trim();
    }

    // Build search query - place name + city
    const query = `${cleanName}, ${cityName}`;
    console.log(`Geocoding: "${query}"`);

    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
      const response = await fetch(url, {
        headers: {
          'User-Agent': 'TripPlanner/1.0'
        }
      });

      if (!response.ok) {
        console.warn(`Geocode failed for "${query}": HTTP ${response.status}`);
        return null;
      }

      const data = await response.json();
      if (data && data.length > 0) {
        const result = {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          displayName: data[0].display_name
        };
        console.log(`  Found: ${result.displayName.substring(0, 50)}...`);
        // Cache the result
        geocodeCache[cacheKey] = result;
        saveGeocodeCache();
        return result;
      }

      console.warn(`  Not found: "${query}"`);
      // Cache null result to avoid repeated lookups
      geocodeCache[cacheKey] = null;
      saveGeocodeCache();
      return null;
    } catch (err) {
      console.error(`Geocode error for "${query}":`, err);
      return null;
    }
  }

  // Geocode multiple places with rate limiting (1 req/sec for Nominatim)
  async function geocodePlaces(places, cityName, onProgress) {
    const results = [];
    let successCount = 0;
    let failCount = 0;

    for (let i = 0; i < places.length; i++) {
      const place = places[i];
      const cacheKey = getCacheKey(place.title, cityName);

      // If already cached (including null), use it
      if (cacheKey in geocodeCache) {
        const cached = geocodeCache[cacheKey];
        results.push({ ...place, geocoded: cached });
        if (cached) successCount++; else failCount++;
        if (onProgress) onProgress(i + 1, places.length, successCount, failCount);
        continue;
      }

      // Geocode with rate limiting
      const result = await geocodePlace(place.title, cityName);
      results.push({ ...place, geocoded: result });
      if (result) successCount++; else failCount++;

      if (onProgress) onProgress(i + 1, places.length, successCount, failCount);

      // Wait 1.2 seconds between requests (Nominatim rate limit with margin)
      if (i < places.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1200));
      }
    }
    return results;
  }

  // Get event coordinates (from event or geocode cache)
  function getEventCoords(event, cityName) {
    // First check if event has explicit coordinates
    if (event.lat && event.lng) {
      return { lat: event.lat, lng: event.lng };
    }

    // Check geocode cache
    const cacheKey = getCacheKey(event.title, cityName);
    const cached = geocodeCache[cacheKey];
    if (cached) {
      return { lat: cached.lat, lng: cached.lng };
    }

    return null;
  }

  // ---------- Render Map ----------
  let selectedMapCity = 'all';
  let selectedMapDay = 'all';

  function renderMap() {
    const mapContainer = document.getElementById('mapContainer');
    const mapLegend = document.getElementById('mapLegend');
    const mapDaySelector = document.getElementById('mapDaySelector');
    const weatherInfo = document.getElementById('weatherInfo');
    const citySelector = document.getElementById('mapCitySelector');

    // Get cities with coordinates
    const citiesWithCoords = trip.cities.map(c => ({
      ...c,
      coords: getCityCoords(c)
    })).filter(c => c.coords);

    // Populate city selector
    const currentSelection = citySelector.value;
    citySelector.innerHTML = '<option value="all">üåç Vista general del viaje</option>';
    citiesWithCoords.forEach(c => {
      citySelector.innerHTML += `<option value="${c.id}" style="color:${c.color};">üìç ${escapeHtml(c.name)}</option>`;
    });
    citySelector.value = currentSelection || 'all';

    // Wire city selector change
    citySelector.onchange = () => {
      selectedMapCity = citySelector.value;
      selectedMapDay = 'all';
      renderMap();
    };

    if (citiesWithCoords.length === 0) {
      mapContainer.innerHTML = '<p style="padding:20px;text-align:center;color:var(--muted);">No hay ciudades con coordenadas disponibles.</p>';
      mapDaySelector.style.display = 'none';
      return;
    }

    // Initialize map if not done
    if (!leafletMap) {
      leafletMap = L.map('mapContainer');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(leafletMap);
    }

    // Clear existing markers and lines
    leafletMap.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline) {
        leafletMap.removeLayer(layer);
      }
    });

    // Determine if we're showing trip overview or city detail
    const selectedCity = citiesWithCoords.find(c => c.id === selectedMapCity);

    if (selectedCity) {
      // CITY DETAIL VIEW
      renderCityMap(selectedCity, mapLegend, mapDaySelector, weatherInfo);
    } else {
      // TRIP OVERVIEW
      renderTripOverviewMap(citiesWithCoords, mapLegend, mapDaySelector, weatherInfo);
    }
  }

  function renderTripOverviewMap(citiesWithCoords, mapLegend, mapDaySelector, weatherInfo) {
    mapDaySelector.style.display = 'none';

    const markers = [];
    const routePoints = [];

    citiesWithCoords.forEach((city, idx) => {
      const { lat, lng } = city.coords;
      routePoints.push([lat, lng]);

      const markerIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          background: ${city.color};
          color: white;
          width: 28px;
          height: 28px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 12px;
          border: 3px solid white;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        ">${idx + 1}</div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });

      const marker = L.marker([lat, lng], { icon: markerIcon })
        .bindPopup(`
          <div style="min-width:150px;">
            <strong>${escapeHtml(city.name)}</strong><br/>
            <span style="color:#666;">üè® ${escapeHtml(city.hotel || 'Sin hotel')}</span><br/>
            <span style="color:#666;">üåô ${city.nights} noches</span>
          </div>
        `)
        .addTo(leafletMap);

      markers.push(marker);
    });

    if (routePoints.length > 1) {
      L.polyline(routePoints, {
        color: '#3b82f6',
        weight: 3,
        opacity: 0.7,
        dashArray: '10, 10'
      }).addTo(leafletMap);
    }

    const group = L.featureGroup(markers);
    leafletMap.fitBounds(group.getBounds().pad(0.1));

    mapLegend.innerHTML = `
      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        ${citiesWithCoords.map((c, i) => `
          <div style="display:flex; align-items:center; gap:6px; cursor:pointer;" onclick="document.getElementById('mapCitySelector').value='${c.id}'; selectedMapCity='${c.id}'; renderMap();">
            <span style="
              background:${c.color};
              color:white;
              width:20px;
              height:20px;
              border-radius:50%;
              display:flex;
              align-items:center;
              justify-content:center;
              font-size:10px;
              font-weight:bold;
            ">${i + 1}</span>
            <span style="font-size:14px;">${escapeHtml(c.name)}</span>
          </div>
        `).join('')}
      </div>
    `;

    // Weather for current city
    const todayDate = new Date().toISOString().slice(0, 10);
    let currentCity = citiesWithCoords[0];
    for (const city of trip.cities) {
      for (const day of (city.days || [])) {
        if (day.date === todayDate) {
          const withCoords = citiesWithCoords.find(c => c.id === city.id);
          if (withCoords) currentCity = withCoords;
          break;
        }
      }
    }

    if (currentCity?.coords) {
      weatherInfo.innerHTML = '<span style="color:var(--muted);font-size:12px;">Cargando...</span>';
      fetchWeather(currentCity.coords.lat, currentCity.coords.lng).then(data => {
        if (data && data.current) {
          const temp = Math.round(data.current.temperature_2m);
          const icon = getWeatherIcon(data.current.weather_code);
          weatherInfo.innerHTML = `
            <div style="display:flex; align-items:center; gap:6px; padding:6px 10px; background:var(--chip); border-radius:8px;">
              <span style="font-size:20px;">${icon}</span>
              <span style="font-weight:600;">${temp}¬∞C</span>
            </div>
          `;
        } else {
          weatherInfo.innerHTML = '';
        }
      });
    }
  }

  function renderCityMap(city, mapLegend, mapDaySelector, weatherInfo) {
    const cityCoords = city.coords;
    const days = city.days || [];
    const cityName = city.name.replace(/\s*\([^)]*\)/g, '').trim(); // Remove parenthetical like "(inicio)"

    // Day colors for routes
    const dayColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];

    // Collect all events and check which have coordinates (explicit or cached)
    const allEvents = [];
    const eventsWithoutCoords = [];

    days.forEach(day => {
      (day.events || []).forEach(evt => {
        const coords = getEventCoords(evt, cityName);
        allEvents.push({ ...evt, resolvedCoords: coords, dayId: day.id });
        if (!coords) {
          eventsWithoutCoords.push(evt);
        }
      });
    });

    // Build day selector with geocode button
    mapDaySelector.style.display = 'block';
    const needsGeocoding = eventsWithoutCoords.length > 0;

    mapDaySelector.innerHTML = `
      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:${needsGeocoding ? '12px' : '0'};">
        <span style="font-weight:600; font-size:14px;">Ver d√≠a:</span>
        <button class="day-filter-btn ${selectedMapDay === 'all' ? 'active' : ''}" data-day="all" style="
          padding: 6px 12px;
          border-radius: 6px;
          border: 1px solid var(--line);
          background: ${selectedMapDay === 'all' ? city.color : 'var(--panel)'};
          color: ${selectedMapDay === 'all' ? 'white' : 'var(--text)'};
          cursor: pointer;
          font-size: 13px;
        ">Todos</button>
        ${days.map((d, i) => `
          <button class="day-filter-btn ${selectedMapDay === d.id ? 'active' : ''}" data-day="${d.id}" style="
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid ${dayColors[i % dayColors.length]};
            background: ${selectedMapDay === d.id ? dayColors[i % dayColors.length] : 'var(--panel)'};
            color: ${selectedMapDay === d.id ? 'white' : dayColors[i % dayColors.length]};
            cursor: pointer;
            font-size: 13px;
          ">D√≠a ${i + 1}</button>
        `).join('')}
      </div>
      ${needsGeocoding ? `
        <div id="geocodePanel" style="padding:12px; background:var(--chip); border-radius:8px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
          <span style="font-size:13px;">üìç ${eventsWithoutCoords.length} lugares sin ubicaci√≥n</span>
          <button id="btnGeocode" class="primary" style="padding:6px 14px; font-size:13px;">
            üîç Buscar ubicaciones autom√°ticamente
          </button>
          <button id="btnClearCache" style="padding:6px 10px; font-size:12px; background:var(--panel); border:1px solid var(--line); border-radius:6px; cursor:pointer;" title="Limpiar cach√© y reintentar lugares no encontrados">
            üîÑ Reintentar fallidos
          </button>
          <span id="geocodeProgress" style="font-size:12px; color:var(--muted);"></span>
        </div>
      ` : ''}
    `;

    // Wire day buttons
    mapDaySelector.querySelectorAll('.day-filter-btn').forEach(btn => {
      btn.onclick = () => {
        selectedMapDay = btn.dataset.day;
        renderMap();
      };
    });

    // Wire clear cache button (retry failed)
    const btnClearCache = document.getElementById('btnClearCache');
    if (btnClearCache) {
      btnClearCache.onclick = () => {
        // Remove only null (failed) entries from cache for this city
        const keysToRemove = [];
        for (const key in geocodeCache) {
          if (geocodeCache[key] === null && key.includes(cityName.toLowerCase())) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(k => delete geocodeCache[k]);
        saveGeocodeCache();
        renderMap();
      };
    }

    // Wire geocode button
    const btnGeocode = document.getElementById('btnGeocode');
    if (btnGeocode) {
      btnGeocode.onclick = async () => {
        btnGeocode.disabled = true;
        btnGeocode.textContent = '‚è≥ Buscando...';
        const progressEl = document.getElementById('geocodeProgress');

        await geocodePlaces(eventsWithoutCoords, cityName, (done, total, success, fail) => {
          progressEl.innerHTML = `${done}/${total} procesados <span style="color:var(--success);">‚úì${success}</span> <span style="color:var(--danger);">‚úó${fail}</span>`;
        });

        // Re-render map with new coordinates
        renderMap();
      };
    }

    const markers = [];
    const allPoints = [];

    // Add hotel marker (home base)
    const hotelIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="
        background: ${city.color};
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      ">üè®</div>`,
      iconSize: [36, 36],
      iconAnchor: [18, 18]
    });

    const hotelMarker = L.marker([cityCoords.lat, cityCoords.lng], { icon: hotelIcon })
      .bindPopup(`
        <div style="min-width:150px;">
          <strong>üè® Hotel Base</strong><br/>
          <span>${escapeHtml(city.hotel || 'Sin hotel definido')}</span><br/>
          <span style="color:#666;">${escapeHtml(city.name)}</span>
        </div>
      `)
      .addTo(leafletMap);

    markers.push(hotelMarker);
    allPoints.push([cityCoords.lat, cityCoords.lng]);

    // Add events for each day
    days.forEach((day, dayIndex) => {
      if (selectedMapDay !== 'all' && selectedMapDay !== day.id) return;

      const dayColor = dayColors[dayIndex % dayColors.length];
      // Get events with resolved coordinates (explicit or geocoded)
      const dayEvents = (day.events || []).map(evt => ({
        ...evt,
        coords: getEventCoords(evt, cityName)
      })).filter(evt => evt.coords);

      const routePoints = [[cityCoords.lat, cityCoords.lng]]; // Start from hotel

      dayEvents.forEach((evt, evtIndex) => {
        const { lat, lng } = evt.coords;
        allPoints.push([lat, lng]);
        routePoints.push([lat, lng]);

        const eventIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="
            background: ${dayColor};
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
          ">${getEventIcon(evt.type)}</div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });

        const marker = L.marker([lat, lng], { icon: eventIcon })
          .bindPopup(`
            <div style="min-width:180px;">
              <strong>${escapeHtml(evt.title)}</strong><br/>
              <span style="color:#666;">üìÖ D√≠a ${dayIndex + 1} - ${day.label}</span><br/>
              ${evt.startTime ? `<span style="color:#666;">üïê ${evt.startTime}${evt.endTime ? ' - ' + evt.endTime : ''}</span><br/>` : ''}
              ${evt.notes ? `<span style="color:#666;">üìù ${escapeHtml(evt.notes)}</span>` : ''}
            </div>
          `)
          .addTo(leafletMap);

        markers.push(marker);
      });

      // Add return to hotel
      if (routePoints.length > 1) {
        routePoints.push([cityCoords.lat, cityCoords.lng]);

        // Draw route for this day
        L.polyline(routePoints, {
          color: dayColor,
          weight: 3,
          opacity: 0.8
        }).addTo(leafletMap);

        // Add numbered markers on route
        routePoints.forEach((point, idx) => {
          if (idx === 0 || idx === routePoints.length - 1) return; // Skip hotel points
          const orderMarker = L.divIcon({
            className: 'route-order',
            html: `<div style="
              background: white;
              color: ${dayColor};
              width: 16px;
              height: 16px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 10px;
              font-weight: bold;
              border: 2px solid ${dayColor};
              box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            ">${idx}</div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          L.marker(point, { icon: orderMarker, interactive: false }).addTo(leafletMap);
        });
      }
    });

    // Fit bounds
    if (allPoints.length > 1) {
      const bounds = L.latLngBounds(allPoints);
      leafletMap.fitBounds(bounds.pad(0.15));
    } else {
      leafletMap.setView([cityCoords.lat, cityCoords.lng], 14);
    }

    // Count events with coordinates (including geocoded)
    const totalEventsWithCoords = allEvents.filter(e => e.resolvedCoords).length;
    const totalEvents = allEvents.length;

    mapLegend.innerHTML = `
      <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center;">
        <div style="display:flex; align-items:center; gap:6px;">
          <span style="font-size:18px;">üè®</span>
          <span style="font-size:13px;">Hotel (base)</span>
        </div>
        ${days.map((d, i) => {
          const eventsInDay = (d.events || []).filter(e => getEventCoords(e, cityName)).length;
          return eventsInDay > 0 ? `
            <div style="display:flex; align-items:center; gap:6px;">
              <span style="width:12px; height:12px; border-radius:50%; background:${dayColors[i % dayColors.length]};"></span>
              <span style="font-size:13px;">D√≠a ${i + 1} (${eventsInDay} lugares)</span>
            </div>
          ` : '';
        }).join('')}
        <div style="margin-left:auto; font-size:12px; color:var(--muted);">
          üìç ${totalEventsWithCoords}/${totalEvents} eventos ubicados
        </div>
      </div>
    `;

    // Weather for city
    if (cityCoords) {
      weatherInfo.innerHTML = '<span style="color:var(--muted);font-size:12px;">...</span>';
      fetchWeather(cityCoords.lat, cityCoords.lng).then(data => {
        if (data && data.current) {
          const temp = Math.round(data.current.temperature_2m);
          const icon = getWeatherIcon(data.current.weather_code);
          weatherInfo.innerHTML = `
            <div style="display:flex; align-items:center; gap:6px; padding:6px 10px; background:var(--chip); border-radius:8px;">
              <span style="font-size:20px;">${icon}</span>
              <span style="font-weight:600;">${temp}¬∞C</span>
            </div>
          `;
        } else {
          weatherInfo.innerHTML = '';
        }
      });
    }
  }

  // ---------- Render Calendar ----------
  // Check if string is a valid time format (HH:MM)
  function isValidTime(str) {
    if (!str) return false;
    return /^\d{1,2}:\d{2}$/.test(str);
  }

  function renderCalendar() {
    const calendarEl = document.getElementById('calendarContainer');

    // Prepare events for FullCalendar
    const events = [];

    for (const city of trip.cities) {
      for (const day of (city.days || [])) {
        for (const evt of (day.events || [])) {
          // Only add time if it's a valid HH:MM format
          const hasValidStart = isValidTime(evt.startTime);
          const hasValidEnd = isValidTime(evt.endTime);

          const start = hasValidStart
            ? day.date + 'T' + evt.startTime
            : day.date;
          const end = hasValidEnd
            ? day.date + 'T' + evt.endTime
            : null;

          // Build title with time label if not a valid time
          let displayTitle = evt.title;
          if (!hasValidStart && evt.startTime) {
            displayTitle = `[${evt.startTime}] ${evt.title}`;
          }

          events.push({
            id: evt.id,
            title: displayTitle,
            start: start,
            end: end,
            allDay: !hasValidStart,
            backgroundColor: city.color,
            borderColor: city.color,
            extendedProps: {
              cityName: city.name,
              type: evt.type,
              notes: evt.notes
            }
          });
        }
      }
    }

    // Initialize or update calendar
    if (!fullCalendar) {
      fullCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: trip.startDate,
        locale: 'es',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        buttonText: {
          today: 'Hoy',
          month: 'Mes',
          week: 'Semana',
          list: 'Lista'
        },
        events: events,
        eventClick: function(info) {
          const props = info.event.extendedProps;
          alert(`${info.event.title}\n\nüìç ${props.cityName}\nüìå ${props.type || 'Evento'}${props.notes ? '\n\nüìù ' + props.notes : ''}`);
        },
        height: 'auto'
      });
      fullCalendar.render();
    } else {
      // Update events
      fullCalendar.removeAllEvents();
      fullCalendar.addEventSource(events);
      fullCalendar.gotoDate(trip.startDate);
    }
  }

  // ---------- Render Today ----------
  function renderToday() {
    const todayContent = document.getElementById('todayContent');
    const todayDate = new Date().toISOString().slice(0, 10);

    let todayCity = null;
    let todayDay = null;

    // Find today's city and day
    for (const city of trip.cities) {
      for (const day of (city.days || [])) {
        if (day.date === todayDate) {
          todayCity = city;
          todayDay = day;
          break;
        }
      }
      if (todayDay) break;
    }

    // If no day found for today, show message
    if (!todayDay) {
      // Check if trip hasn't started yet
      if (todayDate < trip.startDate) {
        const daysUntil = Math.ceil((new Date(trip.startDate) - new Date(todayDate)) / (1000 * 60 * 60 * 24));
        todayContent.innerHTML = `
          <div style="text-align:center; padding:40px;">
            <div style="font-size:48px; margin-bottom:16px;">‚úàÔ∏è</div>
            <h2 style="margin:0 0 8px 0;">¬°Faltan ${daysUntil} d√≠as!</h2>
            <p style="color:var(--muted); margin:0;">Tu viaje comienza el ${formatDateES(trip.startDate)}</p>
          </div>
        `;
      } else {
        todayContent.innerHTML = `
          <div style="text-align:center; padding:40px;">
            <div style="font-size:48px; margin-bottom:16px;">üè†</div>
            <h2 style="margin:0 0 8px 0;">El viaje ha terminado</h2>
            <p style="color:var(--muted); margin:0;">No hay actividades programadas para hoy.</p>
          </div>
        `;
      }
      return;
    }

    // Render today's schedule
    const events = todayDay.events || [];
    const sortedEvents = [...events].sort((a, b) => {
      const timeA = a.startTime || '99:99';
      const timeB = b.startTime || '99:99';
      return timeA.localeCompare(timeB);
    });

    const coords = getCityCoords(todayCity);

    todayContent.innerHTML = `
      <div style="margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
          <div>
            <h2 style="margin:0; display:flex; align-items:center; gap:8px;">
              <span style="width:12px; height:12px; border-radius:50%; background:${todayCity.color};"></span>
              ${escapeHtml(todayCity.name)}
            </h2>
            <p style="margin:4px 0 0 0; color:var(--muted);">${formatDateES(todayDate)} - ${todayDay.label}</p>
          </div>
          <div id="todayWeather" style="min-width:120px;"></div>
        </div>
        ${todayCity.hotel ? `<p style="margin:8px 0 0 0; font-size:14px;">üè® ${escapeHtml(todayCity.hotel)}</p>` : ''}
      </div>

      ${events.length === 0 ? `
        <div style="text-align:center; padding:30px; background:var(--chip); border-radius:12px;">
          <p style="color:var(--muted); margin:0;">No hay eventos programados para hoy.</p>
        </div>
      ` : `
        <div style="display:flex; flex-direction:column; gap:12px;">
          ${sortedEvents.map(evt => `
            <div style="
              background: var(--chip);
              border-radius: 12px;
              padding: 16px;
              border-left: 4px solid ${todayCity.color};
            ">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
                <div style="flex:1;">
                  <div style="font-weight:600; font-size:16px; display:flex; align-items:center; gap:8px;">
                    <span style="font-size:20px;">${getEventIcon(evt.type)}</span>
                    ${escapeHtml(evt.title)}
                    ${evt.ticketRequired ? `<span style="background:${evt.ticketBought ? 'var(--success)' : 'var(--warning)'}; color:white; font-size:10px; padding:2px 6px; border-radius:4px;">${evt.ticketBought ? '‚úì Ticket' : '‚ö† Ticket'}</span>` : ''}
                  </div>
                  ${evt.notes ? `<p style="margin:8px 0 0 0; font-size:14px; color:var(--text-secondary);">üìù ${escapeHtml(evt.notes)}</p>` : ''}
                  ${evt.link ? `<a href="${escapeHtml(evt.link)}" target="_blank" style="font-size:13px; color:var(--accent); text-decoration:none; display:inline-block; margin-top:4px;">üîó Ver enlace</a>` : ''}
                </div>
                <div style="text-align:right; white-space:nowrap;">
                  ${evt.startTime ? `<div style="font-weight:600;">${evt.startTime}</div>` : ''}
                  ${evt.endTime ? `<div style="font-size:13px; color:var(--muted);">- ${evt.endTime}</div>` : ''}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `}
    `;

    // Fetch weather for today
    if (coords) {
      const weatherEl = document.getElementById('todayWeather');
      weatherEl.innerHTML = '<span style="color:var(--muted);font-size:12px;">...</span>';
      fetchWeather(coords.lat, coords.lng).then(data => {
        if (data && data.current) {
          const temp = Math.round(data.current.temperature_2m);
          const icon = getWeatherIcon(data.current.weather_code);
          weatherEl.innerHTML = `
            <div style="display:flex; align-items:center; gap:6px; padding:6px 10px; background:var(--panel); border-radius:8px; border:1px solid var(--line);">
              <span style="font-size:20px;">${icon}</span>
              <span style="font-weight:600;">${temp}¬∞C</span>
            </div>
          `;
        } else {
          weatherEl.innerHTML = '';
        }
      });
    }
  }

  // ---------- ICS Export ----------
  function generateICS() {
    let ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//TripPlanner//ES',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'X-WR-CALNAME:' + (trip.name || 'Mi Viaje'),
    ];

    for (const city of trip.cities) {
      for (const day of (city.days || [])) {
        for (const evt of (day.events || [])) {
          const uid = evt.id + '@tripplanner';
          const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

          // Format date/time for ICS
          let dtstart, dtend;
          if (evt.startTime) {
            dtstart = day.date.replace(/-/g, '') + 'T' + evt.startTime.replace(':', '') + '00';
            if (evt.endTime) {
              dtend = day.date.replace(/-/g, '') + 'T' + evt.endTime.replace(':', '') + '00';
            } else {
              // Default 1 hour duration
              const [h, m] = evt.startTime.split(':').map(Number);
              const endH = String((h + 1) % 24).padStart(2, '0');
              dtend = day.date.replace(/-/g, '') + 'T' + endH + String(m).padStart(2, '0') + '00';
            }
          } else {
            // All day event
            dtstart = day.date.replace(/-/g, '');
            dtend = dtstart;
          }

          const summary = evt.title.replace(/[,;\\]/g, '\\$&');
          const description = [
            city.name,
            evt.type ? `Tipo: ${evt.type}` : '',
            evt.notes ? `Notas: ${evt.notes}` : '',
            evt.link ? `Link: ${evt.link}` : '',
          ].filter(Boolean).join('\\n');

          ics.push('BEGIN:VEVENT');
          ics.push('UID:' + uid);
          ics.push('DTSTAMP:' + dtstamp);
          if (evt.startTime) {
            ics.push('DTSTART:' + dtstart);
            ics.push('DTEND:' + dtend);
          } else {
            ics.push('DTSTART;VALUE=DATE:' + dtstart);
            ics.push('DTEND;VALUE=DATE:' + dtend);
          }
          ics.push('SUMMARY:' + summary);
          ics.push('DESCRIPTION:' + description);
          ics.push('LOCATION:' + city.name.replace(/[,;\\]/g, '\\$&'));
          ics.push('END:VEVENT');
        }
      }
    }

    ics.push('END:VCALENDAR');
    return ics.join('\r\n');
  }

  function exportToICS() {
    const icsContent = generateICS();
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (trip.name || 'viaje').replace(/\s+/g, '_') + '.ics';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Show success message
    const btn = document.getElementById('btnExportICS');
    const originalText = btn.textContent;
    btn.textContent = '‚úì Descargado';
    btn.style.background = 'var(--success)';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = '';
    }, 2000);
  }

  // Add ICS export button handler
  document.getElementById('btnExportICS')?.addEventListener('click', exportToICS);

  // ---------- Render orchestrator ----------
  function renderEverything(renderCal = true) {
    // Save UI state before re-rendering
    saveUIState();

    renderTripMeta();
    renderCities();
    rebuildCityFilter();
    renderAll();
    renderCity();
    renderTickets();
    const active = document.querySelector(".tab.active")?.dataset.tab || "all";
    if (active === "timeline" && renderCal) renderTimeline();

    // Restore UI state after rendering
    restoreUIState();
  }

  // ---------- Init ----------
  rebuildCityFilter();
  renderEverything();

</script>
</body>
</html>
